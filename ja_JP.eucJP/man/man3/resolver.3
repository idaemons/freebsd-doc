.\" Copyright (c) 1985, 1991, 1993
.\"	The Regents of the University of California.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"	This product includes software developed by the University of
.\"	California, Berkeley and its contributors.
.\" 4. Neither the name of the University nor the names of its contributors
.\"    may be used to endorse or promote products derived from this software
.\"    without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\"     @(#)resolver.3	8.1 (Berkeley) 6/4/93
.\"
.\" $FreeBSD$
.Dd June 4, 1993
.Dt RESOLVER 3
.Os BSD 4.3
.Sh 名称
.Nm res_query ,
.Nm res_search ,
.Nm res_mkquery ,
.Nm res_send ,
.Nm res_init ,
.Nm dn_comp ,
.Nm dn_expand
.Nd リゾルバルーチン
.Sh 書式
.Fd #include <sys/types.h>
.Fd #include <netinet/in.h>
.Fd #include <arpa/nameser.h>
.Fd #include <resolv.h>
.Ft int
.Fo res_query
.Fa "const char *dname"
.Fa "int class"
.Fa "int type"
.Fa "u_char *answer"
.Fa "int anslen"
.Fc
.Ft int
.Fo res_search
.Fa "const char *dname"
.Fa "int class"
.Fa "int type"
.Fa "u_char *answer"
.Fa "int anslen"
.Fc
.Ft int
.Fo res_mkquery
.Fa "int op"
.Fa "const char *dname"
.Fa "int class"
.Fa "int type"
.Fa "const u_char *data"
.Fa "int datalen"
.Fa "const u_char *newrr_in"
.Fa "u_char *buf"
.Fa "int buflen"
.Fc
.Ft int
.Fo res_send
.Fa "const u_char *msg"
.Fa "int msglen"
.Fa "u_char *answer"
.Fa "int anslen"
.Fc
.Ft int
.Fn res_init 
.Fo dn_comp
.Fa "const char *exp_dn"
.Fa "u_char *comp_dn"
.Fa "int length"
.Fa "u_char **dnptrs"
.Fa "u_char **lastdnptr"
.Fc
.Ft int
.Fo dn_expand
.Fa "const u_char *msg"
.Fa "const u_char *eomorig"
.Fa "const u_char *comp_dn"
.Fa "char *exp_dn"
.Fa "int length"
.Fc
.Sh 解説
このルーチンは、インターネットドメインネームサーバを使用し、クエリと
応答メッセージの作成、送信、解釈を行ないます。
.Pp
リゾルバルーチンが使用するグローバル設定と状態の情報は、構造体
.Em _res
に保存されます。ほとんどの値は、適切なデフォルトになっているので無視で
きます。  
.Em _res.options
に保存されているオプションは、
.Pa resolv.h
で以下のように定義されています。オプションは、有効なオプションのビット
ワイズ論理和を含む、単純なビットマスクとして保存されています。 
.Bl -tag -width RES_DEFNAMES
.It Dv RES_INIT
初期ネームサーバアドレスとデフォルトドメイン名が初期化されている場合は
真です(
.Fn res_init
が呼び出された場合など)。
.It Dv RES_DEBUG
デバッグメッセージを出力します。
.It Dv RES_AAONLY
信頼できる応答のみを受け入れます。このオプションを使用した場合は、信頼
できる応答かエラーが見つかるまで 
.Fn res_send
を続ける必要があります。現在のところ、これは実現されていません。
.It Dv RES_USEVC     UDP
データグラムの代わりに
.Tn TCP
接続をクエリに使用します。
.It DV RES_STAYOPEN
.Dv RES_USEVC
とともに使用し、クエリ間で
.Tn TCP
接続を開いたままに保ちます。多くのクエリを定期的に行なうプログラムのみ
で便利です。
.Tn UDP
は通常モードである必要があります。
.It Dv RES_IGNTC
現在は使用されません(TCPで再試行しないなど、トランケーションエラーを無
視)。
.It Dv RES_RECURSE
クエリの反復要求ビットを設定します。これがデフォルトです。(
.Fn res_send
は反復クエリを行なわず、ネームサーバが反復を処理することを期待します。)
.It Dv RES_DEFNAMES
設定すると、
.Fn res_search
がシングルコンポーネント名(ドットを含まない名前)にデフォルトのドメイン
名を追加するようになります。このオプションはデフォルトで有効になってい
ます。
.It Dv RES_DNSRCH
このオプションを設定すると、
.Fn res_search
が、現在のドメインと親ドメインでホスト名を検索するようになります。
.Xr hostname 7
を参照してください。これは、標準ホスト検索ルーチン
.Xr gethostbyname 3
によって使用されます。このオプションはデフォルトで有効になっています。 
.It Dv NOALIASES
このオプションは、
.Dq Ev HOSTALIASES
環境変数が制御するユーザレベルエイリアシング機能を無効にします。ネット
ワークデーモンでは、このオプションを設定する必要があります。
.El
.Pp
.Fn res_init
ルーチンは、設定ファイルを読み込み(設定ファイルが存在する場合。
.Xr Resolver 5
参照)、デフォルトドメイン名、検索リスト、ローカルネームサーバのインター
ネットアドレスを入手します。サーバが設定されていない場合は、リゾルバを
実行しているホストが試されます。現在のドメイン名は、設定ファイルで指定
されていない場合、ホスト名で定義されますが、環境変数
.Ev LOCALDOMAIN
で上書きされることがあります。検索リストをプロセスごとに上書きする場合
は、ブランクで区切られた複数のトークンをこの環境変数に含めます。これは、
設定ファイルの 
.Em search
コマンドに似ています。別の環境変数
.Dq Ev RES_OPTIONS
を設定すれば、特定の内部リゾルバオプションを上書きできます。内部リゾル
バオプションは、上書きされなければ、
.Em _res
構造体のフィールドを変更することで設定されるか、設定ファイルの
.Em options
コマンドから継承されます。
.Dq Ev RES_OPTIONS
環境変数のシンタックスについては、
.Xr resolver 5
を参照してください。通常の場合、初期化は以下のルーチンを初めて呼び出し
たときに実行されます。
.Pp
.Fn res_query
関数は、サーバクエリメカニズムのインタフェースを提供するもので、クエリ
の作成、作成されたクエリのローカルサーバへの送信、リスポンスの待機、応
答の予備チェックを行ないます。クエリは、指定された完全に適格なドメイン
名 
.Fa dname
で、指定された
.Fa type
と
.Fa class
の情報を要求します。応答メッセージは、
.Fa answer
バッファに残され、呼び出し側が指定する
.Fa anslen
の長さになっています。
.Pp
.Fn res_search
ルーチンは、
.Fn res_query
と同じようにクエリの作成とリスポンスの待機を行ないますが、
.Dv RES_DEFNAMES
と
.Dv RES_DNSRCH
オプションが制御するデフォルトと検索規則も実現します。最初の問題がない
応答が戻されます。
.Pp
残りのルーチンは、
.Fn res_query
が使用する低レベルルーチンです。
.Fn res_mkquery
関数は、標準クエリメッセージを作成して
.Fa buf
に配置し、クエリのサイズを戻します。クエリが
.Fa buflen
より長い場合は \-1 を戻します。クエリタイプ
.Fa op
は、通常の場合
.Dv QUERY
ですが、
.Aq Pa arpa/nameser.h
で定義されているクエリタイプにできます。クエリのドメイン名は
.Fa dname
で指定します。
.Fa Newrr
は現在使用されていませんが、更新メッセージを作成するためのものです。
.Pp
.Fn res_send
ルーチンは、事前フォーマット済みクエリを送信し、応答を戻します。
.Dv RES_INIT
が設定されていない場合は
.Fn res_init
を呼び出します。ローカルネームサーバへのクエリの送信、およびタイムアウ
トと再試行の処理も行ないます。応答メッセージの長さを戻しますが、エラー
がある場合は \-1 を戻します。
.Pp
.Fn dn_comp
関数は、ドメイン名
.Fa exp_dn
を圧縮し、
.Fa comp_dn
に保存します。圧縮された名前のサイズを戻しますが、エラーがある場合は 
\-1 を戻します。 
.Fa comp_dn
が指す配列のサイズは
.Fa length
で指定します。圧縮では、現在のメッセージで以前に圧縮された名前を指すポ
インタ 
.Fa dnptrs
の配列を使用します。最初のポインタはメッセージの最初を指し、リストは
.Dv NULL
で終わります。配列の制限は
.Fa lastdnptr
で指定します。
.Fn dn_comp
の副作用は、名前が圧縮されたときにメッセージに挿入されるラベルのポイン
タのリストが更新されることです。 
.Em dnptr
が
.Dv NULL
である場合、名前は圧縮されません。
.Fa lastdnptr
が
.Dv NULL
である場合、ラベルのリストは更新されません。
.Pp
.Fn dn_expand
エントリは、圧縮されたドメイン名
.Fa comp_dn
を完全ドメイン名に展開します。圧縮された名前は、クエリか応答メッセージに
含まれます。
.Fa msg
は、メッセージの最初を指すポインタです。展開された名前は、
.Fa exp_dn
が示すバッファに配置されます。バッファのサイズは
.Fa length
です。圧縮された名前のサイズが戻されますが、エラーがある場合は \-1 が
戻されます。 
.Sh 関連ファイル
.Bl -tag -width Pa
/etc/resolv.conf
設定ファイル。
.Xr resolver 5
を参照してください。
.El
.Sh 関連項目
.Xr gethostbyname 3 ,
.Xr resolver 5 ,
.Xr hostname 7 ,
.Xr named 8
.Pp
.%T RFC1032 ,
.%T RFC1033 ,
.%T RFC1034 ,
.%T RFC1035 ,
.%T RFC974
.Rs
.%T "Name Server Operations Guide for BIND"
.Re
.Sh 歴史
.Fn res_query
関数は、
.Bx 4.3
に追加されました。
