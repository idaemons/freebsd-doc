.\" Copyright (c) 1980, 1991, 1993
.\"	The Regents of the University of California.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"	This product includes software developed by the University of
.\"	California, Berkeley and its contributors.
.\" 4. Neither the name of the University nor the names of its contributors
.\"    may be used to endorse or promote products derived from this software
.\"    without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\"     @(#)execve.2	8.5 (Berkeley) 6/1/94
.\" %FreeBSD: src/lib/libc/sys/execve.2,v 1.11.2.4 1999/08/29 14:49:00 peter Exp %
.\"
.Dd June 1, 1994
.Dt EXECVE 2
.Os BSD 4
.Sh 名称
.Nm execve
.Nd ファイルを実行する
.Sh 書式
.Fd #include <unistd.h>
.Ft int
.Fn execve "const char *path" "char *const argv[]" "char *const envp[]"
.Sh 解説
.Fn execve
は呼び出しプロセスを新しいプロセスに変換します。新しいプロセスは
.Fa path
によって指される新しいプロセスファイル
.Em new process file
と呼ばれる通常のファイルで構成されます。
このファイルは実行可能オブジェクトファイル、またはインタプリタ用の
データのファイルです。実行可能オブジェクトファイルは、識別ヘッダに
データのページが続いたもので構成されます。このデータは
初期プログラム (テキスト) と初期値ありデータのページを表します。
追加のページはヘッダで指定され、0 データで初期化されます。
.Xr a.out 5
を参照してください。
.Pp
インタプリタファイルは次の形式の行で開始します。
.Pp
.Bd -filled -offset indent -compact
.Sy \&#!
.Em interpreter
.Bq Em arg
.Ed
.Pp
インタプリタファイルが
.Sy execve
されるとき、システムは実際には指定の
.Em インタプリタ
を
.Sy execve
します。オプションの
.Em arg
が指定されている場合、それは
.Em インタプリタ
の 1番目の引数に
なり、元々の
.Sy execve
で指定されたファイルは 2 番目の引数になります。それ以外では
.Sy execve
で指定されたファイルの名前が 1番目の引数になります。
元々の引数はシフトされて後続の引数に
なります。0 番目の引数は
.Sy execve
されたファイルの名前で通常は変更されません。
.Pp
引数
.Fa argv
は、NUL で終了する文字列を指す、NULL で終了する
文字ポインタの配列を指すポインタです。
これらの文字列は、新しいプロセスで利用できるように引数リストを構成します。
少なくとも 1 つの引数が配列内に存在している必要があります。
慣習では、最初の要素が実行されたプログラムの名前になるはずです (たとえば、
.Fa path
の最後の構成要素)。
.Pp
引数
.Fa envp
も、NUL で終了する文字列を指す、NULL で終了する
文字ポインタの配列を指すポインタです。
この配列を指すポインタは、通常、グローバル変数
.Va environ
に保存されます。これらの文字列は、コマンドへの直接的
引数ではない情報を新しいプロセスに渡します
.Pf ( Xr environ 7
を参照)。
.Pp
呼び出しプロセスイメージ内で開いているファイル記述子は、
新しいプロセスイメージの中で開いたままです。
しかし、close-on-exec フラグが設定されているものは例外です。
.Pf ( Xr close 2
と
.Xr fcntl 2
を参照)。
開いたままの記述子は
.Fn execve
の影響を受けません。
.Pp
呼び出しプロセスで無視するよう設定されたシグナルは、
新しいプロセス内で無視されるよう設定されます。
呼び出しプロセスイメージ内で捕捉されるよう設定されたシグナルは、
新しいプロセスイメージ内でデフォルトのアクションに
設定されます。ブロックされたシグナルは、
シグナルアクションの変化とは無関係にブロックされたままになります。
シグナルスタックは未定義であるようリセットされます (詳細については
.Xr sigaction 2
を参照してください)。
.Pp
新しいプロセスイメージファイルの set-user-ID モードビット
が設定されている場合
.Pf ( Xr chmod 2
を参照)、新しいプロセスイメージの実効ユーザ ID は、
新しいプロセスイメージファイルの所有者 ID に設定されます。
新しいプロセスイメージファイルの set-group-ID モードビットが
設定されている場合、新しいプロセスイメージの実効グループ ID は新しい
プロセスイメージファイルのグループ ID に設定されます
(実効グループ ID はグループリストの最初の要素です)。
新しいプロセスの実ユーザ ID、実グループ ID、およびその他の
グループ ID は、呼び出しプロセスイメージと同じになります。
set-user-ID および set-group-ID 処理の後、実効ユーザ ID は
saved set-user-ID として記録され、実効グループ ID は
saved set-group-ID として記録されます。
これらの値は、後で実効 ID を変更するのに使用できます
.Pf ( Xr setuid 2
を参照)。
.ne 1i
.Pp
該当するファイルシステムで
.Ar nosuid
オプションが有効な場合、または新しいプロセスファイルがインタプリタ
ファイルの場合、set-ID ビットは尊重されません。
実効 ID が変更された場合、システムコールのトレースは
無効になります。
.Pp
また、新しいプロセスは呼び出しプロセスから次の属性を継承します。
.Pp
.Bl -column parent_process_ID -offset indent -compact
.It process ID Ta Xr getpid 2 \ を参照
.It parent process ID Ta Xr getppid 2 \ を参照
.It process group ID Ta Xr getpgrp 2 \ を参照
.It access groups Ta Xr getgroups 2 \ を参照
.It working directory Ta Xr chdir 2 \ を参照
.It root directory Ta Xr chroot 2 \ を参照
.It control terminal Ta Xr termios 4 \ を参照
.It resource usages Ta Xr getrusage 2 \ を参照
.It interval timers Ta Xr getitimer 2 \ を参照
.It resource limits Ta Xr getrlimit 2 \ を参照
.It file mode mask Ta Xr umask 2 \ を参照
.It signal mask Ta Xr sigvec 2 ,
.Xr sigsetmask 2 \ を参照
.El
.Pp
.Fn execve
呼び出しの結果として実行されるとき、プログラムは次のように呼び出されます。
.Bd -literal -offset indent
main(argc, argv, envp)
int argc;
char **argv, **envp;
.Ed
.Pp
ここで、
.Fa argc
は
.Fa argv
の要素数 (``arg count'') であり、
.Fa argv
は、引数自身を指す文字ポインタの配列を指します。
.Sh システムの注意事項
.Pp
非スレッドライブラリ
.Fn execve
は
.Va execve
システムコールとして実装されています。
.Pp
スレッドライブラリでは、
.Va execve
システムコールは
.Fn _thread_sys_execve
にアセンブルされ、
.Fn execve
は、ユーザスレッドライブラリ再初期化を行なってから、
.Fn _thread_sys_execve
を呼び出す関数として実装されています。
.Sh 戻り値
.Fn execve
は現在のプロセスイメージを新しいプロセスイメージで上書きするので、
処理が成功した呼び出しには戻るプロセスがありません。
.Fn execve
が呼び出しプロセスに返ってくる場合は
エラーが起きています。戻り値は -1 が返され、
エラーを示すためにグローバル変数
.Va errno
が設定されます
.Sh エラー
次の場合、
.Fn Execve
は処理に失敗し、呼び出しプロセスに戻ります。
.Bl -tag -width [ENAMETOOLONG]
.It Bq Er ENOTDIR
パスの構成要素中にディレクトリ以外のものが含まれています。
.It Bq Er ENAMETOOLONG
パス名の構成要素が 255 文字を越えているか、
またはパス名全体が 1023 文字を越えています。
.It Bq Er ENOENT
新しいプロセスファイルが存在しません。
.It Bq Er ELOOP
パス名を変換するときに検出されたシンボリックリンクが多すぎます。
.It Bq Er EACCES
前置パス名の構成要素について検索許可が拒否されています。
.It Bq Er EACCES
新しいプロセスファイルが通常のファイルではありません。
.It Bq Er EACCES
新しいプロセスファイルのモードで実行許可が拒否されています。
.It Bq Er ENOEXEC
新しいプロセスファイルに適切なアクセス許可がありますが、
ヘッダのマジック番号が無効です。
.It Bq Er ETXTBSY
新しいプロセスファイルは純粋な手続き (共有テキスト) ファイルですが、
現時点で書込みまたは読取り用に開かれています。
.ne 1i
.It Bq Er ENOMEM
新しいプロセスは、許された 
.Pq Xr getrlimit 2 で課された最大値
以上の仮想メモリを必要とします。
.It Bq Er E2BIG
新しいプロセスの引数リストのバイト数がシステムの課した上限を
越えています。この上限は、
.Xr sysctl 3
の MIB 変数
.Dv KERN_ARGMAX
により指定されます。
.It Bq Er EFAULT
新しいプロセスファイルは、ヘッダ内のサイズ値で
示されるほど長くはありません。
.It Bq Er EFAULT
.Fa path ,
.Fa argv ,
または
.Fa envp
が正しくないアドレスを指しています。
.It Bq Er EIO
ファイルシステムから読取る間に入出力エラーが発生しました。
.El
.Sh 警告
プログラムがスーパユーザでないものに対して
.Em setuid
されていて、実
.Em uid
が``root''の時に実行された場合、プログラムはスーパユーザの力の
いくらかも同時に持ちます。
.Sh 関連項目
.Xr ktrace 1 ,
.Xr _exit 2 ,
.Xr fork 2 ,
.Xr execl 3 ,
.Xr exit 3 ,
.Xr sysctl 3 ,
.Xr environ 7 ,
.Xr mount 8
.Sh 歴史
.Fn execve
関数は
.Bx 4.2
で登場しました。
