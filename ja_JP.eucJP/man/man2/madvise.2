.\" Copyright (c) 1991, 1993
.\"	The Regents of the University of California.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"	This product includes software developed by the University of
.\"	California, Berkeley and its contributors.
.\" 4. Neither the name of the University nor the names of its contributors
.\"    may be used to endorse or promote products derived from this software
.\"    without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\"	@(#)madvise.2	8.1 (Berkeley) 6/9/93
.\" %FreeBSD: src/lib/libc/sys/madvise.2,v 1.14.2.1 1999/08/29 14:49:11 peter Exp %
.\"
.Dd Jul 19, 1996
.Dt MADVISE 2
.Os
.Sh 名称
.Nm madvise
.Nd メモリの使用法について助言を与える
.Sh 書式
.Fd #include <sys/types.h>
.Fd #include <sys/mman.h>
.Ft int
.Fn madvise "void *addr" "size_t len" "int behav"
.Sh 解説
.Fn madvise
システムコールによって、自身のメモリ利用の習性の知識があるプロセスは、それを
システムに説明できます。
.Aq Pa sys/mman.h
で定義される既知の習性は次のとおりです。
.Bd -literal
#define	MADV_NORMAL	0 /* これ以降、特殊な処理は必要ない */
#define	MADV_RANDOM	1 /* ランダムなページ参照が予測される */
#define	MADV_SEQUENTIAL	2 /* シーケンシャルな参照が予測される */
#define	MADV_WILLNEED	3 /* これらのページを必要とする */
#define	MADV_DONTNEED	4 /* これらのページを必要としない */
#define	MADV_FREE	5 /* データは今や重要ではない */
.Ed
.Pp
.Bl -tag -width MADV_SEQUENTIAL 
.It Dv MADV_NORMAL
デフォルトのページング動作に戻るようにシステムに指示します。
.It Dv MADV_RANDOM
ページがランダムにアクセスされ、プリフェッチが有利ではないと考えられるという
ヒントです。
.It Dv MADV_SEQUENTIAL
指定のページがフォルトで読み込まれたとき、そのページの直前のページの
優先順位を VM システムが下げるようにします。
.It Dv MADV_WILLNEED
指定の仮想アドレス範囲内にあるページが一時的に高い優先順位を持つようにし、
それらがメモリ内にある場合、解放される可能性を減少させます。
さらに既にメモリ内に
あるページはただちにプロセスにマップされ、それによって
プロセス全体にわたるフォルトによる読み込みによる
不要なオーバーヘッドを除去します。
これはフォルトによるページのバッキングストアからの読み込みを起こさず、
メモリ内に既にあるページを呼び出し側のプロセスに素早くマップします。
.It Dv MADV_DONTNEED
VM システムに、指定の範囲内のページのメモリ内優先順位の減少を許可します。
さらに、このアドレス範囲への将来の参照はページフォルトを発生させるでしょう。
.It Dv MADV_FREE
VM システムにページを解放する自由を与え、指定ページ範囲内の情報がもはや
重要でないことをシステムに通知します。これは、アドレス空間を有効にしたままで
.Xr malloc 3
がアドレス空間内の任意の位置のページを解放できるようにする効率的な方法です。
ページが次に参照される時には、そのページは要求時ゼロクリアの対象に
なっている可能性もありますし、または
.Dv MADV_FREE
呼び出しの前にそこにあったデータが残っているかもしれません。
ページが再び修正されるまで、そのアドレス空間範囲に対する参照だけでは、
VM システムはバッキングストアから情報をページに読み込む動作を行わなくなります。
.El
.Sh 戻り値
正常に完了すると
.Fn madvise
は 0 を返します。そうでない場合は値 -1 を
返し、エラーを示すために
.Va errno
が設定されます。
.Sh エラー
.Fn madvise
関数は次の場合に失敗します。
.Bl -tag -width Er
.It Bq Er EINVAL
.Fa addr
引数と
.Fa len
引数で指定された仮想アドレス範囲が有効ではありません。
.El
.Sh 関連項目
.Xr mincore 2 ,
.Xr mprotect 2 ,
.Xr msync 2 ,
.Xr munmap 2 .
.Sh 歴史
.Fn madvise
関数は
.Bx 4.4
ではじめて登場しました。
