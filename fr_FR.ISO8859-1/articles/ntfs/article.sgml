<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!DOCTYPE article PUBLIC "-//FreeBSD//DTD DocBook XML V4.2-Based Extension//EN"
	"../../../share/sgml/freebsd42.dtd" [
<!ENTITY % entities PUBLIC "-//FreeBSD//ENTITIES DocBook FreeBSD Entity Set//FR" "../../share/sgml/entities.ent">
%entities;
]>

<!--
     The FreeBSD Documentation Project
     The FreeBSD French Documentation Project

     $FreeBSD$
     Original revision: n.nn
-->

<article id="ntfs" lang="fr">
  <articleinfo>
    <title>Installer le pilote NTFS pour FreeBSD</title>
    <abstract>

      &trans.a.laurand;
    </abstract>

    <pubdate>$FreeBSD$</pubdate>

    <releaseinfo>$FreeBSD$</releaseinfo>
  </articleinfo>

  <sect1>
    <title>Installer le pilote NTFS pour FreeBSD 3.x</title>

    <para>Pour installer ce pilote, vous aurez besoin de recompiler un noyau car
      les fichiers d'en-tête utilisés seront mis &agrave; niveau.
      Pour autant, aucun changement dans le fichier de configuration ne sera
      nécessaire. Si vous n'avez pas installé les sources du
      noyau, vous pouvez soit recourir &agrave; <filename>sysinstall</filename>,
      ou bien entrer successivement en tant que
      <username>root</username>&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>mount -t cd9660 /dev/cd0c /mnt</userinput>
&prompt.root; <userinput> cd /mnt/src</userinput>
&prompt.root; <userinput> cat ssys.?? | tar --unlink -zxpvf - -C /usr/src</userinput></screen>
    </informalexample>

    <para>Le pilote requiert également le fichier
      <filename>mntopt.h</filename> de l'archive source. Pour
      extraire son contenu&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput> cd /mnt/src</userinput>
&prompt.root; <userinput> cat ssbin.?? | tar --unlink -zxpvf - -C /usr/src sbin/mount</userinput></screen>
    </informalexample>

    <para>Ensuite, en tant que <username>root</username>, créez un
      répertoire pour y extraire le contenu de l'archive du pilote
      ntfs&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput> cd /tmp</userinput>
&prompt.root; <userinput> mkdir ntfs</userinput></screen>
    </informalexample>

    <para>Téléchargez le fichier d'archive compressé
      contenant le code source du pilote ainsi que son fichier de mise &agrave;
      niveau&nbsp;-&nbsp;<foreignphrase>patch</foreignphrase>&nbsp;-&nbsp;dans
      <filename>/tmp/ntfs</filename>. Les deux fichiers dont vous avez besoin
      sont <filename>ntfs-0.17beta.tgz</filename> et
      <filename>ntfs.0.17beta-0.18beta.diff</filename>.</para>

    <para>Extrayez le contenu du fichier d'archive&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput> cd /tmp/ntfs</userinput>
&prompt.root; <userinput> tar xzvf ntfs-0.17beta.tgz</userinput></screen>
    </informalexample>

    <para>Il se peut que le numéro de version (0.17beta) soit
      différent.</para>

    <para>Ensuite, appliquez la mise &agrave; niveau de la version 0.17 &agrave;
      la version 0.18.</para>

    <informalexample>
<screen>&prompt.root; <userinput> cd /tmp/ntfs/src/sys/ntfs</userinput>
&prompt.root; <userinput> patch &lt; /tmp/ntfs/ntfs.0.17beta-0.18beta.diff</userinput></screen>
    </informalexample>

    <para>Prenez garde &agrave; ce qu'aucune partie ne fasse défaut.
      <citerefentry><refentrytitle>patch</refentrytitle>
      <manvolnum>1</manvolnum></citerefentry> génère des copies de
      sauvegarde des fichiers qu'il met &agrave; jour (avec l'extension
      <filename>.orig</filename>), par conséquent, si un problème
      survient, recopiez les fichiers <filename>.orig</filename>, et
      recherchez-en la cause.</para>

    <para>Recopiez maintenant les fichiers sources l&agrave; où ils
      doivent normalement être&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd /tmp/ntfs</userinput>
&prompt.root; <userinput>cp -p -R -i src /usr/</userinput></screen>
    </informalexample>

    <para>Il faut ensuite mettre &agrave; jour
      <filename>vnode.h</filename>&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd /usr/src/sys/sys</userinput>
&prompt.root; <userinput>patch &lt; /tmp/ntfs/diff/vnode.h.diff</userinput></screen>
    </informalexample>

    <para>Encore une fois, vérifiez que la mise &agrave; niveau s'est
      bien passée, vous devriez avoir&nbsp;:</para>

    <programlisting>
Hmm...  Looks like a new-style context diff to me...
The text leading up to this was:
--------------------------
|*** ./sys/sys/vnode.h.orig      Fri Jan  1 06:12:51 1999
|--- ./sys/sys/vnode.h  Wed Dec   2 12:31:31 1998
--------------------------
Patching file vnode.h using Plan A...
Hunk #1 succeeded at 62.
done
    </programlisting>

    <para>Vous allez maintenant pouvoir maintenant compiler l'exécutable
      <filename>mount_ntfs</filename>&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd /usr/src/sbin/mount_ntfs</userinput>
&prompt.root; <userinput>make</userinput>
&prompt.root; <userinput>make install</userinput></screen>
    </informalexample>

<para>ainsi que le module du noyau&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd /usr/src/sys/modules/ntfs</userinput>
&prompt.root; <userinput>make</userinput>
&prompt.root; <userinput>make install</userinput></screen>
    </informalexample>

    <para>Pour finir, il faudra aussi recompiler le noyau (parce que
      <filename>vnode.h</filename> a été modifié). Si vous
      utilisez le noyau <filename>GENERIC</filename>, faites une copie
      du fichier de configuration du noyau <filename>GENERIC</filename> (ce
      n'est pas absolument nécessaire, mais de cette manière le
      nom du noyau sera mis &agrave; jour, et il sera plus facile d'identifier
      celui avec lequel vous démarrez). J'ai pour habitude d'utiliser
      des noms assez représentatifs, aussi
      <filename>GENERIC_NTFS</filename> me semble-t-il
      approprié&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd /usr/src/sys/i386/conf</userinput>
&prompt.root; <userinput>cp GENERIC GENERIC_NTFS</userinput>
&prompt.root; <userinput>/usr/sbin/config GENERIC_NTFS</userinput>
&prompt.root; <userinput>cd ../../compile/GENERIC_NTFS</userinput>
&prompt.root; <userinput>make depend</userinput>
&prompt.root; <userinput>make</userinput>
&prompt.root; <userinput>make install</userinput></screen>
    </informalexample>

    <para>Ok, parfait, mais avant de redémarrer avec votre nouveau noyau,
      il faut identifier la
      tranche&nbsp;-&nbsp;<foreignphrase>slice</foreignphrase>&nbsp;-&nbsp;NTFS.
      Le numéro de cette tranche va dépendre du format de votre
      disque. Pour l'instant, si vous avez une tranche FAT suivie d'une tranche
      NTFS et que votre tranche FreeBSD est la dernière, elles seront
      numérotées (&ldquo;<literal>da</literal>&rdquo; ou
      peut-être &ldquo;<literal>sd</literal>&rdquo; pour les disques SCSI,
      si vous avez mis &agrave; jour votre système 2.2.x pour passer en
      3.1, et ce sera &ldquo;<literal>wd</literal>&rdquo; si vous avez des
      disques IDE)&nbsp;:</para>

    <programlisting>
FAT     - da0s1
NTFS    - da0s2
FreeBSD - da0s3
     </programlisting>

    <para>Si votre tranche NTFS et votre tranche FreeBSD sont inversées
      et que vous avez installé NT avant FreeBSD, ce qui est d'ailleurs        la méthode recommandée, vos numéros de
      tranches seront les mêmes, mais pas dans le même
      ordre&nbsp;:</para>

    <programlisting>
FAT     - da0s1
FreeBSD - da0s3
NTFS    - da0s2
    </programlisting>

    <para>Vous pouvez jeter un coup d'oeil au fichier
      <filename>/etc/fstab</filename> pour être sûr du numéro
      de la tranche de FreeBSD (et également de celui de la tranche
      FAT).</para>

    <para>Il y a cependant une exception &agrave; tout cela, lorsque votre
      tranche NTFS est une &ldquo;partition logique&rdquo; dans une
      &ldquo;partition étendue&rdquo;. Les &ldquo;partitions
      logiques&rdquo; sont toujours numérotées &agrave; partir de
      5, peut importe le nombre de &ldquo;partitions&rdquo; sur le disque. Mon
      disque, par exemple, est agencé comme ceci&nbsp;:</para>

    <programlisting>
FAT                - da0s1
FreeBSD            - da0s3
Extended partition - da0s2
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NTFS - da0s5
    </programlisting>

    <para>Notez qu'une &ldquo;partition étendue;&rdquo; se voit attribuer
      une
      tranche&nbsp;-&nbsp;&ldquo;<foreignphrase>slice</foreignphrase>&rdquo;,
      mais celle-ci ne peut pas être utilisée en tant que telle,
      c'est-&agrave;-dire que vous ne pouvez pas la monter.</para>

    <para>Après avoir identifié la tranche NTFS, vous pouvez
      ajouter une entrée dans le fichier
      <filename>/etc/fstab</filename>. Notez que l'option <literal>ro</literal>
      signifie que le montage se fera en lecture seule (souvenez-vous que le
      pilote est en lecture seule). Cette entrée provoquera le montage
      automatique de la tranche NTFS lors du démarrage. Si vous voulez
      désactiver cette dernière option, modifiez
      <literal>ro</literal> en <literal>ro,noauto</literal>, sans aucun espace
      ni avant ni après la virgule&nbsp;! Vous aurez également
      besoin d'un point de montage, <filename>/ntfs</filename> dans cet
      exemple, ou si vous préferez, <filename>/mnt</filename> &agrave;
      la place de <filename>/ntfs</filename> dans le fichier
      <filename>/etc/fstab</filename>&nbsp;:</para>

    <programlisting>
# Device            Mountpoint       FStype    Options          Dump     Pass#
/dev/da0s5  	    /ntfs            ntfs      ro               0        0
    </programlisting>

    <para>Si vous préferez ne pas monter la &ldquo;partition&rdquo; au
      démarrage, montez-la ensuite en tant que <username>root</username>
      avec la commande&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>mount -t ntfs /dev/da0s5 /ntfs</userinput></screen>
    </informalexample>

    <para>Bien entendu, ajustez le fichier de pilote de
      périphérique ainsi que le point de montage &agrave; votre
      système.</para>

    <para>C'est fait&nbsp;! Il ne reste plus qu'&agrave;
      redémarrer.</para>

    <para>Bon courage&nbsp;! </para>

  </sect1>

  <sect1>
    <title>Installation du pilote NTFS sous FreeBSD 2.2.X</title>

    <para>Pour installer ce pilote, vous aurez besoin de recompiler un noyau car
      les fichiers d'en-tête utilisés seront mis &agrave; niveau.
      Pour autant, aucun changement dans le fichier de configuration ne sera
      nécessaire. Si vous n'avez pas installé les sources du
      noyau, vous pouvez soit recourir &agrave; <filename>sysinstall</filename>,
      ou bien entrer successivement en tant que
      <username>root</username>&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>mount -t cd9660 /dev/cd0c /mnt</userinput>
&prompt.root; <userinput> cd /mnt/src</userinput>
&prompt.root; <userinput> cat ssys.?? | tar --unlink -zxpvf - -C /usr/src</userinput></screen>
    </informalexample>

    <para>Le pilote requiert également les fichiers
      <filename>mntopt.h</filename> de l'archive source. Pour extraire son
      contenu, tapez&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput> cd /mnt/src</userinput>
&prompt.root; <userinput> cat ssbin.?? | tar --unlink -zxpvf - -C /usr/src sbin/mount</userinput></screen>
    </informalexample>

    <para>Ensuite, en tant que <username>root</username>, créez un
      répertoire pour extraire le contenu de l'archive du pilote
      ntfs&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput> cd /tmp</userinput>
&prompt.root; <userinput> mkdir ntfs</userinput></screen>
    </informalexample>

    <para>Téléchargez le fichier d'archive compressé
      contenant le code source du pilote ainsi que son fichier de mise &agrave;
      jour dans <filename>/tmp/ntfs</filename>.</para>

    <para>Extrayez le contenu de l'archive&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput> cd /tmp/ntfs</userinput>
&prompt.root; <userinput> tar xzvf ntfs-releng22-0.12beta.tgz</userinput></screen>
    </informalexample>

    <para>Il se peut que le numéro de version (0.12beta) soit
      différent.</para>

    <para>Recopiez maintenant les fichiers sources &agrave; l'endroit
      adéquat&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd src</userinput>
&prompt.root; <userinput>cp -p -r * /usr/src</userinput></screen>
    </informalexample>

    <para>Ensuite, vous devez mettre &agrave; niveau les 3 fichiers
      d'en-tête du système. Utilisez l'option <option>-l</option>
      (L minuscule) qui permet d'ignorer la différence d'espacement, car
      j'ai remarqué que l'utilisation des touches <keycap>TAB</keycap>
      et <keycap>Espace</keycap> rendait incompatible les fichiers originaux et
      les fichiers <filename>diff</filename>.</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd /usr/src/sys/sys</userinput>
&prompt.root; <userinput>patch -l malloc.h /tmp/ntfs/diff/malloc.h.diff</userinput>
&prompt.root; <userinput>patch -l mount.h /tmp/ntfs/diff/mount.h.diff</userinput>
&prompt.root; <userinput>patch -l vnode.h /tmp/ntfs/diff/vnode.h.diff</userinput></screen>
    </informalexample>

    <para>Si cette opération réussit, vous verrez s'afficher
      quelque chose de similaire &agrave;&nbsp;:</para>

    <programlisting>
Hmm...  Looks like a new-style context diff to me...
The text leading up to this was:
--------------------------
|*** ./sys/sys/vnode.h.orig      Fri Jan  1 00:17:30 1999
|--- ./sys/sys/vnode.h  Fri Jan   1 00:17:35 1999
--------------------------
Patching file vnode.h using Plan A...
Hunk #1 succeeded at 58.
done
    </programlisting>

    <para>Si malencontreusement, un (ou plusieurs) fichier de mise &agrave;
      jour faisait défaut, sachez que
      <citerefentry><refentrytitle>patch</refentrytitle></citerefentry>
      fait toujours des copies des fichiers originaux avec le même nom
      suivi de l'extension <filename>.orig</filename>.</para>

    <para>Maintenant, vous pouvez compiler le pilote. Il est nécessaire
      d'ajouter <literal>BINDIR=/usr/sbin</literal> qui n'est pas
      défini dans le <filename>Makefile</filename>.</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd /usr/src/sbin/i386/mount_ntfs</userinput>
&prompt.root; <userinput>make</userinput>
&prompt.root; <userinput>make BINDIR=/usr/sbin install</userinput></screen>
    </informalexample>

    <para>Compilez ensuite les modules du noyau&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd /usr/src/lkm</userinput>
&prompt.root; <userinput>make</userinput>
&prompt.root; <userinput>make install</userinput></screen>
    </informalexample>

    <para>Pour finir, vous devez recompiler le noyau. Si vous utilisez le noyau
      <filename>GENERIC</filename>, faites une copie du fichier de configuration
      du noyau <filename>GENERIC</filename> (ce n'est pas absolument
      nécessaire, mais de cette manière le nom du noyau sera mis
      &agrave; jour, et ce sera plus facile pour identifier le noyau avec lequel
      vous démarrez). J'ai pour habitude d'utiliser des noms assez
      représentatifs, aussi <filename>GENERIC_NTFS</filename> me semble
      approprié&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>cd /usr/src/sys/i386/conf</userinput>
&prompt.root; <userinput>cp GENERIC GENERIC_NTFS</userinput>
&prompt.root; <userinput>/usr/sbin/config GENERIC_NTFS</userinput>
&prompt.root; <userinput>cd ../../compile/GENERIC_NTFS</userinput>
&prompt.root; <userinput>make depend</userinput>
&prompt.root; <userinput>make</userinput>
&prompt.root; <userinput>make install</userinput></screen>
    </informalexample>

    <para>Ok, parfait, mais avant de redémarrer avec votre nouveau noyau,
      il faut identifier la
      tranche&nbsp;-&nbsp;<foreignphrase>slice</foreignphrase>&nbsp;-&nbsp;NTFS.
      Le numéro de cette tranche va dépendre du format de votre
      disque. Pour l'instant, si vous avez une tranche FAT suivie d'une tranche
      NTFS et que votre tranche FreeBSD est la dernière, elles seront
      numérotées (remplacez &ldquo;<literal>w</literal>&rdquo; par
      &ldquo;<literal>s</literal>&rdquo; pour les disques SCSI)&nbsp;:</para>

    <programlisting>
FAT     - wd0s1
NTFS    - wd0s2
FreeBSD - wd0s3
    </programlisting>

    <para>Si votre tranche NTFS et votre tranche FreeBSD sont inversées
      et que vous avez installé NT avant FreeBSD, ce qui est d'ailleurs        la méthode recommandée, vos numéros de
      tranches seront les mêmes, mais pas dans le même
      ordre&nbsp;:</para>

    <programlisting>
FAT     - wd0s1
FreeBSD - wd0s3
NTFS    - wd0s2
    </programlisting>

    <para>Vous pouvez jeter un coup d'oeil au fichier
      <filename>/etc/fstab</filename> pour être sûr du numéro
      de la tranche FreeBSD (et également de celui de la tranche
      FAT).</para>

    <para>Il y a cependant une exception &agrave; tout cela, lorsque votre
      tranche NTFS est une &ldquo;partition logique&rdquo; dans une
      &ldquo;partition étendue&rdquo;. Les &ldquo;partitions
      logiques&rdquo; sont toujours numérotées &agrave; partir de
      5, peut importe le nombre de &ldquo;partitions&rdquo; sur le disque. Mon
      disque, par exemple, est agencé comme ceci&nbsp;:</para>

    <programlisting>
FAT                - sd0s1
FreeBSD            - sd0s3
Extended partition - sd0s2
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NTFS - sd0s5
    </programlisting>

    <para>Notez qu'une &ldquo;partition étendue&rdquo; se voit attribuer
      une
      tranche&nbsp;-&nbsp;&ldquo;<foreignphrase>slice</foreignphrase>&rdquo;,
      mais celle-ci ne peut pas être utilisée en tant que telle,
      c'est-&agrave;-dire que vous ne pouvez pas la monter.</para>

    <para>Après avoir identifié la tranche NTFS, vous pouvez
      ajouter une entrée dans le fichier
      <filename>/etc/fstab</filename>. Notez que l'option <literal>ro</literal>
      signifie que le montage se fera en lecture seule (souvenez-vous que le
      pilote est en lecture seule). Cette entrée provoquera le montage
      automatique de la tranche NTFS lors du démarrage. Si vous voulez
      désactiver cette dernière option, modifiez
      <literal>ro</literal> en <literal>ro,noauto</literal>, sans aucun espace
      ni avant ni après la virgule&nbsp;! Vous aurez également
      besoin d'un point de montage, <filename>/ntfs</filename> dans cet
      exemple, ou si vous préferez, <filename>/mnt</filename> &agrave;
      la place de <filename>/ntfs</filename> dans le fichier
      <filename>/etc/fstab</filename>&nbsp;:</para>

    <programlisting>
# Device            Mountpoint       FStype    Options          Dump     Pass#
/dev/sd0s5  	    /ntfs            ntfs      ro               0        0
    </programlisting>

    <para>Si vous préferez ne pas monter la &ldquo;partition&rdquo; au
      démarrage, montez-la ensuite en tant que <username>root</username>
      avec la commande&nbsp;:</para>

    <informalexample>
<screen>&prompt.root; <userinput>mount -t ntfs /dev/sd0s5 /ntfs</userinput></screen>
    </informalexample>

    <para>Bien entendu, ajustez le fichier de pilote de
      périphérique ainsi que le point de montage &agrave; votre
      système.</para>

    <para>C'est fait&nbsp;! Il ne reste plus qu'&agrave;
      redémarrer. Si vous avez choisi de monter la
      &ldquo;partition&rdquo; au démarrage, vous verrez s'afficher
      quelques messages de diagnostic tout &agrave; fait
      inoffensifs&nbsp;:</para>

    <programlisting>
ntfs_init():
ntfs_mountfs(): bps: 512, spc: 1, media: f8, mftrecsz: 2 (2 sects)
ntfs_mountfs(): mftcn: 0x315e5|0x287245
ntfs_mountfs(): case-sens., uid: 0, gid: 0, mode: 777
ntfs_iget(): read &dollar;MFT ntnode
ntfs_mountfs(): reading &dollar;UpCase....OK
    </programlisting>

    <para>Bon courage&nbsp;! </para>

  </sect1>
</article>
