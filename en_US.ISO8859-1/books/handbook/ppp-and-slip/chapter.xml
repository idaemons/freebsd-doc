<?xml version="1.0" encoding="iso-8859-1"?>
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->

<chapter id="ppp-and-slip">
  <!--
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Jim</firstname>
	<surname>Mock</surname>
	<contrib>Restructured, reorganized, and updated by in Mar 2000</contrib>
      </author>
    </authorgroup>
  </chapterinfo>
  -->

  <title><acronym>PPP</acronym></title>

  <sect1 id="ppp-and-slip-synopsis">
    <title>Synopsis</title>

    <indexterm id="ppp-ppp">
      <primary><acronym>PPP</acronym></primary>
    </indexterm>

    <para>&os; has a number of ways to link one computer to another.
      To establish a network or Internet connection through a dial-up
      modem, or to allow others to do so through you, requires the use
      of <acronym>PPP</acronym>.  This chapter describes setting u
      p these modem-based communication services in detail.</para>

    <para>After reading this chapter, you will know:</para>

    <itemizedlist>
      <listitem>
	<para>How to set configure <acronym>PPP</acronym>.</para>
      </listitem>
      <listitem>
	<para>How to set up <acronym>PPP</acronym> over Ethernet
	  (<acronym>PPPoE</acronym>).</para>
      </listitem>
      <listitem>
	<para>How to set up <acronym>PPP</acronym> over ATM
	  (<acronym>PPPoA</acronym>).</para>
      </listitem>
    </itemizedlist>

    <indexterm>
      <primary><acronym>PPP</acronym></primary>
    </indexterm>
    <indexterm>
      <primary><acronym>PPP</acronym></primary>
      <secondary>over Ethernet</secondary>
    </indexterm>

    <para>Before reading this chapter, you should:</para>

    <itemizedlist>
      <listitem>
	<para>Be familiar with basic network terminology.</para>
      </listitem>
      <listitem>
	<para>Understand the basics and purpose of a dialup connection
	  and <acronym>PPP</acronym>.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 id="userppp">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Updated and enhanced by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Brian</firstname>
	  <surname>Somers</surname>
	  <contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Nik</firstname>
	  <surname>Clayton</surname>
	  <contrib>With input from </contrib>
	</author>
	<author>
	  <firstname>Dirk</firstname>
	  <surname>Fr&ouml;mberg</surname>
	</author>
	<author>
	  <firstname>Peter</firstname>
	  <surname>Childs</surname>
	</author>
      </authorgroup>
    </sect1info>
    -->

    <title>Configuring <acronym>PPP</acronym></title>

    <para>This document assumes you have the following:</para>

    <itemizedlist>
      <listitem>
	<para>An account with an Internet Service Provider
	  (<acronym>ISP</acronym>) which you connect to using
	  <acronym>PPP</acronym>.</para>
      </listitem>

      <listitem>
	<para>A modem or other device connected to your system and
	  properly configured to allow you to connect to your
	  ISP.</para>
      </listitem>

      <listitem>
	<para>The dial-up number(s) of your ISP.</para>
      </listitem>

      <listitem>
	<para>The login name and password assigned by the ISP.</para>
      </listitem>

      <listitem>
	<para>The IP address of one or more name servers.
	  Normally, you will be given two IP addresses by your
	  ISP to use for this.  If they have not given you at
	  least one, then you can use the <command>enable
	    dns</command> command in <filename>ppp.conf</filename>
	  and <application>ppp</application> will set the name
	  servers for you.  This feature depends on your ISP's
	  <acronym>PPP</acronym> implementation supporting DNS
	  negotiation.</para>
      </listitem>
    </itemizedlist>

    <para>The following information may be supplied by your ISP, but
      is not completely necessary:</para>

    <itemizedlist>
      <listitem>
	<para>The IP address of your ISP's gateway.  The gateway is
	  the machine to which you will connect and will be set up as
	  your <emphasis>default route</emphasis>.  If you do not have
	  this information, we can make one up and your ISP's PPP
	  server will tell us the correct value when we
	  connect.</para>

	<para>This IP number is referred to as
	  <literal>HISADDR</literal> by
	  <application>ppp</application>.</para>
      </listitem>

      <listitem>
	<para>The netmask you should use.  If your ISP has not
	  provided you with one, you can safely use <hostid
	    role="netmask">255.255.255.255</hostid>.</para>
      </listitem>

      <listitem>
	<indexterm id="ppp-static-ip">
	  <primary>static IP address</primary>
	</indexterm>

	<para>If your ISP provides you with a static IP address and
	  hostname, you can enter it.  Otherwise, we simply let the
	  peer assign whatever IP address it sees fit.</para>
      </listitem>
    </itemizedlist>

    <para>If you do not have any of the required information, contact
      your ISP.</para>

    <note>
      <para>Throughout this section, many of the examples showing the
	contents of configuration files are numbered by line.  These
	numbers serve to aid in the presentation and discussion only
	and are not meant to be placed in the actual file.  Proper
	indentation with tab and space characters is also
	important.</para>
    </note>

    <para><command>ppp</command> uses the configuration files located
      in <filename class="directory">/etc/ppp</filename>.  Examples
      can be found in <filename
	class="directory">/usr/share/examples/ppp/</filename>.</para>

    <para>Configuring <command>ppp</command> requires that you edit a
      number of files, depending on your requirements.  What you put
      in them depends to some extent on whether your ISP allocates IP
      addresses statically (i.e., you get given one IP address, and
      always use that one) or dynamically (i.e., your IP address
      changes each time you connect to your ISP).</para>

    <sect2 id="userppp-staticIP">
      <title>PPP With Static IP Addresses</title>

      <indexterm>
	<primary>PPP</primary>
	  <secondary>with static IP addresses</secondary>
      </indexterm>

      <para>You will need to edit the
	<filename>/etc/ppp/ppp.conf</filename> configuration file.
	It should look similar to the example below.</para>

      <note>
	<para>Lines that end in a <literal>:</literal> start in the
	  first column (beginning of the line)&mdash; all other lines
	  should be indented as shown using spaces or tabs.</para>
      </note>

      <programlisting>1     default:
2       set log Phase Chat LCP IPCP CCP tun command
3       ident user-ppp VERSION (built COMPILATIONDATE)
4       set device /dev/cuau0
5       set speed 115200
6       set dial "ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 5 \
7                 \"\" AT OK-AT-OK ATE1Q0 OK \\dATDT\\T TIMEOUT 40 CONNECT"
8       set timeout 180
9       enable dns
10
11    provider:
12      set phone "(123) 456 7890"
13      set authname foo
14      set authkey bar
15      set login "TIMEOUT 10 \"\" \"\" gin:--gin: \\U word: \\P col: ppp"
16      set timeout 300
17      set ifaddr <replaceable>x.x.x.x</replaceable> <replaceable>y.y.y.y</replaceable> 255.255.255.255 0.0.0.0
18      add default HISADDR</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term>Line 1:</term>

	      <listitem>
		<para>Identifies the default entry.  Commands in this
		  entry are executed automatically when ppp is
		  run.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 2:</term>

	      <listitem>
		<para>Enables logging parameters.  When the
		  configuration is working satisfactorily, this line
		  should be reduced to saying:</para>

		  <programlisting>set log phase tun</programlisting>

		<para>in order to avoid excessive log file
		  sizes.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 3:</term>

	      <listitem>
		<para>Tells PPP how to identify itself to the peer.
		  PPP identifies itself to the peer if it has any
		  trouble negotiating and setting up the link,
		  providing information that the peers administrator
		  may find useful when investigating such
		  problems.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 4:</term>

	      <listitem>
		<para>Identifies the device to which the modem is
		  connected.  <devicename>COM1</devicename> is
		  <filename class="devicefile">/dev/cuau0</filename>
		  and
		  <devicename>COM2</devicename> is
		  <filename
		    class="devicefile">/dev/cuau1</filename>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 5:</term>

	      <listitem>
		<para>Sets the speed you want to connect at.  If
		  115200 does not work (it should with any reasonably
		  new modem), try 38400 instead.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 6 &amp; 7:</term>

	      <listitem>
		<para>The dial string.  PPP uses an expect-send
		  syntax similar to the &man.chat.8; program.  Refer
		  to the manual page for information on the features
		  of this language.</para>

		<para>Note that this command continues onto the next
		  line for readability.  Any command in
		  <filename>ppp.conf</filename> may do this if the
		  last character on the line is a <literal>\</literal>
		  character.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 8:</term>

	      <listitem>
		<para>Sets the idle timeout for the link.  180 seconds
		  is the default, so this line is purely
		  cosmetic.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 9:</term>

	      <listitem>
		<para>Tells PPP to ask the peer to confirm the local
		  resolver settings.  If you run a local name server,
		  this line should be commented out or removed.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 10:</term>

	      <listitem>
		<para>A blank line for readability.  Blank lines are
		  ignored by PPP.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 11:</term>

	      <listitem>
		<para>Identifies an entry for a provider called
		  <quote>provider</quote>.  This could be changed
		  to the name of your <acronym>ISP</acronym> so
		  that later you can use the <option>load
		    <replaceable>ISP</replaceable></option> to start
		  the connection.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 12:</term>

	      <listitem>
		<para>Sets the phone number for this provider.
		  Multiple phone numbers may be specified using the
		  colon (<literal>:</literal>) or pipe character
		  (<literal>|</literal>) as a separator.  The
		  difference between the two separators is described
		  in &man.ppp.8;.  To summarize, if you want to rotate
		  through the numbers, use a colon.  If you want to
		  always attempt to dial the first number first and
		  only use the other numbers if the first number
		  fails, use the pipe character.  Always quote the
		  entire set of phone numbers as shown.</para>

		<para>You must enclose the phone number in quotation
		  marks (<literal>"</literal>) if there is any
		  intention on using spaces in the phone number.
		  This can cause a simple, yet subtle error.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 13 &amp; 14:</term>

	      <listitem>
		<para>Identifies the user name and password.  When
		  connecting using a &unix; style login prompt, these
		  values are referred to by the <command>set
		    login</command> command using the \U and \P
		  variables.  When connecting using PAP or CHAP, these
		  values are used at authentication time.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 15:</term>

	      <listitem>
		<para>If you are using
		  PAP<indexterm><primary>PAP</primary></indexterm> or
		  CHAP<indexterm><primary>CHAP</primary></indexterm>,
		  there will be no login at this point, and this line
		  should be commented out or removed.  See <xref
		    linkend="userppp-PAPnCHAP"/> for further
		  details.</para>

		<para>The login string is of the same chat-like
		  syntax as the dial string.  In this example, the
		  string works for a service whose login session looks
		  like this:</para>

		<screen>J. Random Provider
login: <replaceable>foo</replaceable>
password: <replaceable>bar</replaceable>
protocol: ppp</screen>

		<para>You will need to alter this script to suit your
		  own needs.  When you write this script for the first
		  time, you should ensure that you have enabled
		  <quote>chat</quote> logging so you can determine if
		  the conversation is going as expected.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 16:</term>

	      <listitem>
		<para>Sets the default idle
		  timeout<indexterm><primary>timeout</primary></indexterm>
		  (in seconds) for the connection.  Here, the
		  connection will be closed automatically after 300
		  seconds of inactivity.  If you never want to
		  timeout, set this value to zero or use the
		  <option>-ddial</option> command line switch.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 17:</term>
	      <listitem>
		<para>Sets the interface addresses.  The string
		  <replaceable>x.x.x.x</replaceable> should be
		  replaced by the IP address that your
		  provider<indexterm><primary>ISP</primary></indexterm>
		  has allocated to you.  The string
		  <replaceable>y.y.y.y</replaceable> should be
		  replaced by the IP address that your ISP indicated
		  for their gateway (the machine to which you
		  connect).  If your ISP has not given you a gateway
		  address, use <hostid
		    role="netmask">10.0.0.2/0</hostid>.  If you need
		  to use a <quote>guessed</quote> address, make sure
		  that you create an entry in
		  <filename>/etc/ppp/ppp.linkup</filename> as per the
		  instructions in <xref
		    linkend="userppp-dynamicIP"/>.  If this line is
		  omitted,  <command>ppp</command> cannot run in
		  <option>-auto</option> mode.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 18:</term>

	      <listitem>
		<para>Adds a default route to your ISP's gateway.  The
		  special word <literal>HISADDR</literal> is replaced
		  with the gateway address specified on line 17.  It
		  is important that this line appears after line 17,
		  otherwise <literal>HISADDR</literal> will not yet
		  be initialized.</para>

		<para>If you do not wish to run ppp in
		  <option>-auto</option>, this line should be moved
		  to the <filename>ppp.linkup</filename> file.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para>It is not necessary to add an entry to
	    <filename>ppp.linkup</filename> when you have a static
	    IP address and are running ppp in <option>-auto</option>
	    mode as your routing table entries are already correct
	    before you connect.  You may however wish to create an
	    entry to invoke programs after connection.  This is
	    explained later with the sendmail example.</para>

	  <para>Example configuration files can be found in the
	    <filename
	      class="directory">/usr/share/examples/ppp/</filename>
	    directory.</para>
	</sect2>

	<sect2 id="userppp-dynamicIP">
	  <title><acronym>PPP</acronym> With Dynamic IP
	    Addresses</title>

	  <indexterm>
	    <primary><acronym>PPP</acronym></primary>
	    <secondary>with dynamic IP addresses</secondary>
	  </indexterm>

	  <indexterm>
	    <primary>IPCP</primary>
	  </indexterm>

	  <para>If your service provider does not assign static IP
	    addresses, <command>ppp</command> can be configured to
	    negotiate the local and remote addresses.  This is done by
	    <quote>guessing</quote> an IP address and allowing
	    <command>ppp</command> to set it up correctly using the IP
	    Configuration Protocol (IPCP) after connecting.  The
	    <filename>ppp.conf</filename> configuration is the same as
	    that described in <xref
	      linkend="userppp-staticIP"/>, with the following
	    change:</para>

	  <programlisting>17      set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.255 0.0.0.0</programlisting>

	  <para>Again, do not include the line number, it is just for
	    reference.  Indentation of at least one space is
	    required.</para>

	  <variablelist>
	    <varlistentry>
	      <term>Line 17:</term>

	      <listitem>
		<para>The number after the <literal>/</literal>
		  character is the number of bits of the address that
		  ppp will insist on.  You may wish to use IP numbers
		  more appropriate to your circumstances, but the
		  above example will always work.</para>

		<para>The last argument (<literal>0.0.0.0</literal>)
		  tells PPP to start negotiations using address
		  <hostid role="ipaddr">0.0.0.0</hostid> rather than
		  <hostid role="ipaddr">10.0.0.1</hostid> and is
		  necessary for some ISPs.  Do not use
		  <literal>0.0.0.0</literal> as the first argument
		  to <command>set ifaddr</command> as it prevents
		  PPP from setting up an initial route in
		  <option>-auto</option> mode.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para>If you are not running in <option>-auto</option> mode,
	    you will need to create an entry in
	    <filename>/etc/ppp/ppp.linkup</filename>.
	    <filename>ppp.linkup</filename> is used after a connection
	    has been established.  At this point,
	    <command>ppp</command> will have assigned the interface
	    addresses and it will now be possible to add the routing
	    table entries:</para>

	  <programlisting>1     provider:
2      add default HISADDR</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term>Line 1:</term>

	      <listitem>
		<para>On establishing a connection,
		  <command>ppp</command> will look for an entry in
		  <filename>ppp.linkup</filename> according to the
		  following rules: First, try to match the same label
		  as we used in <filename>ppp.conf</filename>.  If
		  that fails, look for an entry for the IP address of
		  our gateway.  This entry is a four-octet IP style
		  label.  If we still have not found an entry, look
		  for the <literal>MYADDR</literal> entry.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 2:</term>

	      <listitem>
		<para>This line tells <command>ppp</command> to add a
		  default route that points to
		  <literal>HISADDR</literal>.
		  <literal>HISADDR</literal> will be replaced with the
		  IP number of the gateway as negotiated by the
		  IPCP.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para>See the <literal>pmdemand</literal> entry in the files
	    <filename>/usr/share/examples/ppp/ppp.conf.sample</filename>
	    and
	    <filename>/usr/share/examples/ppp/ppp.linkup.sample</filename>
	    for a detailed example.</para>
	</sect2>

	<sect2>
	  <title>Receiving Incoming Calls</title>

	  <indexterm>
	    <primary><acronym>PPP</acronym></primary>
	    <secondary>receiving incoming calls</secondary>
	  </indexterm>

	  <para>When you configure <application>ppp</application> to
	    receive incoming calls on a machine connected to a LAN,
	    you must decide if you wish to forward packets to the LAN.
	    If you do, you should allocate the peer an IP number from
	    your LAN's subnet, and use the command <command>enable
	      proxy</command> in your
	    <filename>/etc/ppp/ppp.conf</filename> file.  You should
	    also confirm that the <filename>/etc/rc.conf</filename>
	    file contains the following:</para>

	  <programlisting>gateway_enable="YES"</programlisting>
	</sect2>

	<sect2>
	  <title>Which getty?</title>

	  <para><xref linkend="dialup"/>
	    provides a good description
	    on enabling dial-up services using &man.getty.8;.</para>

	  <para>An alternative to <command>getty</command> is <ulink
	      url="http://mgetty.greenie.net/">mgetty</ulink> (from
	    <filename role="package">comms/mgetty+sendfax</filename>
	    port), a smarter version of <command>getty</command>
	    designed with dial-up lines in mind.</para>

	  <para>The advantages of using <command>mgetty</command> is
	    that it actively <emphasis>talks</emphasis> to modems,
	    meaning if port is turned off in
	    <filename>/etc/ttys</filename> then your modem will not
	    answer the phone.</para>

	  <para>Later versions of <command>mgetty</command> (from
	    0.99beta onwards) also support the automatic detection of
	    <acronym>PPP</acronym> streams, allowing your clients
	    script-less access to your server.</para>

	  <para>Refer to <xref linkend="userppp-mgetty"/> for more
	    information on <command>mgetty</command>.</para>
	</sect2>

	<sect2>
	  <title><application>PPP</application> Permissions</title>

	  <para>The <command>ppp</command> command must normally be
	    run as the <username>root</username> user.  If however,
	    you wish to allow <command>ppp</command> to run in
	    server mode as a normal user by executing
	    <command>ppp</command> as described below, that user
	    must be given permission to run <command>ppp</command>
	    by adding them to the <groupname>network</groupname>
	    group in <filename>/etc/group</filename>.</para>

	  <para>You will also need to give them access to one or more
	    sections of the configuration file using the
	    <command>allow</command> command:</para>

	  <programlisting>allow users fred mary</programlisting>

	  <para>If this command is used in the
	    <literal>default</literal> section, it gives the specified
	    users access to everything.</para>
	</sect2>

	<sect2>
	  <title><acronym>PPP</acronym> Shells for Dynamic IP
	    Users</title>

	  <indexterm>
	    <primary><acronym>PPP</acronym> shells</primary>
	  </indexterm>

	  <para>Create a file called
	    <filename>/etc/ppp/ppp-shell</filename> containing the
	    following:</para>

	  <programlisting>#!/bin/sh
IDENT=`echo $0 | sed -e 's/^.*-\(.*\)$/\1/'`
CALLEDAS="$IDENT"
TTY=`tty`

if [ x$IDENT = xdialup ]; then
        IDENT=`basename $TTY`
fi

echo "PPP for $CALLEDAS on $TTY"
echo "Starting PPP for $IDENT"

exec /usr/sbin/ppp -direct $IDENT</programlisting>

	  <para>This script should be executable.  Now make a
	    symbolic link called <filename>ppp-dialup</filename> to
	    this script using the following commands:</para>

	  <screen>&prompt.root; <userinput>ln -s ppp-shell /etc/ppp/ppp-dialup</userinput></screen>

	  <para>You should use this script as the
	    <emphasis>shell</emphasis> for all of your dialup users.
	    This is an example from <filename>/etc/passwd</filename>
	    for a dialup <acronym>PPP</acronym> user with username
	    <username>pchilds</username> (remember do not directly
	    edit the password file, use &man.vipw.8;).</para>

	    <programlisting>pchilds:*:1011:300:Peter Childs PPP:/home/ppp:/etc/ppp/ppp-dialup</programlisting>

	    <para>Create a <filename
		class="directory">/home/ppp</filename> directory that
	      is world readable containing the following 0 byte
	      files:</para>

	    <screen>-r--r--r--   1 root     wheel           0 May 27 02:23 .hushlogin
-r--r--r--   1 root     wheel           0 May 27 02:22 .rhosts</screen>

	    <para>which prevents <filename>/etc/motd</filename> from
	      being displayed.</para>
	  </sect2>

	  <sect2>
	    <title><acronym>PPP</acronym> Shells for Static IP
	      Users</title>

	    <indexterm>
	      <primary><acronym>PPP</acronym> shells</primary>
	    </indexterm>

	    <para>Create the <filename>ppp-shell</filename> file as
	      above, and for each account with statically assigned
	      IPs create a symbolic link to
	      <filename>ppp-shell</filename>.</para>

	    <para>For example, if you have three dialup customers,
	      <username>fred</username>, <username>sam</username>,
	      and <username>mary</username>, that you route /24 CIDR
	      networks for, you would type the following:</para>

	    <screen>&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-fred</userinput>
&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-sam</userinput>
&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-mary</userinput></screen>

	    <para>Each of these users dialup accounts should have
	      their shell set to the symbolic link created above (for
	      example, <username>mary</username>'s shell should be
	      <filename>/etc/ppp/ppp-mary</filename>).</para>
	  </sect2>

	  <sect2>
	    <title>Setting Up <filename>ppp.conf</filename> for
	      Dynamic IP Users</title>

	    <para>The <filename>/etc/ppp/ppp.conf</filename> file
	      should contain something along the lines of:</para>

	    <programlisting>default:
  set debug phase lcp chat
  set timeout 0

ttyu0:
  set ifaddr 203.14.100.1 203.14.100.20 255.255.255.255
  enable proxy

ttyu1:
  set ifaddr 203.14.100.1 203.14.100.21 255.255.255.255
  enable proxy</programlisting>

	    <note>
	      <para>The indenting is important.</para>
	    </note>

	    <para>The <literal>default:</literal> section is loaded
	      for each session.  For each dialup line enabled in
	      <filename>/etc/ttys</filename> create an entry similar
	      to the one for <literal>ttyu0:</literal> above.  Each
	      line should get a unique IP address from your pool of
	      IP addresses for dynamic users.</para>
	  </sect2>

	  <sect2>
	    <title>Setting Up <filename>ppp.conf</filename> for
	      Static IP Users</title>

	    <para>Along with the contents of the sample
	      <filename>/usr/share/examples/ppp/ppp.conf</filename>
	      above you should add a section for each of the
	      statically assigned dialup users.  We will continue with
	      our <username>fred</username>, <username>sam</username>,
	      and <username>mary</username> example.</para>

	    <programlisting>fred:
  set ifaddr 203.14.100.1 203.14.101.1 255.255.255.255

sam:
  set ifaddr 203.14.100.1 203.14.102.1 255.255.255.255

mary:
  set ifaddr 203.14.100.1 203.14.103.1 255.255.255.255</programlisting>

	    <para>The file <filename>/etc/ppp/ppp.linkup</filename>
	      should also contain routing information for each static
	      IP user if required.  The line below would add a route
	      for the <hostid role="ipaddr">203.14.101.0/24</hostid>
	      network via the client's ppp link.</para>

	    <programlisting>fred:
  add 203.14.101.0 netmask 255.255.255.0 HISADDR

sam:
  add 203.14.102.0 netmask 255.255.255.0 HISADDR

mary:
  add 203.14.103.0 netmask 255.255.255.0 HISADDR</programlisting>
	</sect2>

	<sect2 id="userppp-mgetty">
	  <title><command>mgetty</command> and AutoPPP</title>

	  <indexterm>
	    <primary><command>mgetty</command></primary>
	  </indexterm>

	  <indexterm>
	    <primary>AutoPPP</primary>
	  </indexterm>

	  <indexterm>
	    <primary>LCP</primary>
	  </indexterm>

	  <para>By default the <filename
	      role="package">comms/mgetty+sendfax</filename> port
	    comes with the <literal>AUTO_PPP</literal> option enabled
	    allowing <command>mgetty</command> to detect the LCP
	    phase of <acronym>PPP</acronym> connections and
	    automatically spawn off a ppp shell.  However, since the
	    default login/password sequence does not occur it is
	    necessary to authenticate users using either PAP or
	    CHAP.</para>

	  <para>This section assumes the user has successfully
	    compiled, and installed the <filename
	      role="package">comms/mgetty+sendfax</filename> port on
	    his system.</para>

	  <para>Make sure your
	    <filename>/usr/local/etc/mgetty+sendfax/login.config</filename>
	    file has the following in it:</para>

	  <programlisting>/AutoPPP/ -     - /etc/ppp/ppp-pap-dialup</programlisting>

	  <para>This will tell <command>mgetty</command> to run the
	    <filename>ppp-pap-dialup</filename> script for detected
	    <acronym>PPP</acronym> connections.</para>

	  <para>Create a file called
	    <filename>/etc/ppp/ppp-pap-dialup</filename> containing
	    the following (the file should be executable):</para>

	  <programlisting>#!/bin/sh
exec /usr/sbin/ppp -direct pap$IDENT</programlisting>

	  <para>For each dialup line enabled in
	    <filename>/etc/ttys</filename>, create a corresponding
	    entry in <filename>/etc/ppp/ppp.conf</filename>.  This
	    will happily co-exist with the definitions we created
	    above.</para>

	  <programlisting>pap:
  enable pap
  set ifaddr 203.14.100.1 203.14.100.20-203.14.100.40
  enable proxy</programlisting>

	  <para>Each user logging in with this method will need to
	    have a username/password in
	    <filename>/etc/ppp/ppp.secret</filename> file, or
	    alternatively add the following option to authenticate
	    users via PAP from the <filename>/etc/passwd</filename>
	    file.</para>

	  <programlisting>enable passwdauth</programlisting>

	  <para>If you wish to assign some users a static IP number,
	    you can specify the number as the third argument in
	    <filename>/etc/ppp/ppp.secret</filename>.  See
	    <filename>/usr/share/examples/ppp/ppp.secret.sample</filename>
	    for examples.</para>
	</sect2>

	<sect2>
	  <title>MS Extensions</title>

	  <indexterm>
	    <primary>DNS</primary>
	  </indexterm>

	  <indexterm>
	    <primary>NetBIOS</primary>
	  </indexterm>

	  <indexterm>
	    <primary><acronym>PPP</acronym></primary>
	    <secondary>Microsoft extensions</secondary>
	  </indexterm>

	  <para>It is possible to configure PPP to supply DNS and
	    NetBIOS nameserver addresses on demand.</para>

	  <para>To enable these extensions with
	    <acronym>PPP</acronym> version 1.x, the following lines
	    might be added to the relevant section of
	    <filename>/etc/ppp/ppp.conf</filename>.</para>

	  <programlisting>enable msext
set ns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</programlisting>

	  <para>And for <acronym>PPP</acronym> version 2 and
	    above:</para>

	  <programlisting>accept dns
set dns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</programlisting>

	  <para>This will tell the clients the primary and secondary
	    name server addresses, and a NetBIOS nameserver
	    host.</para>

	  <para>In version 2 and above, if the
	    <literal>set dns</literal> line is omitted,
	    <acronym>PPP</acronym> will use the values found in
	    <filename>/etc/resolv.conf</filename>.</para>
	</sect2>

	<sect2 id="userppp-PAPnCHAP">
	  <title>PAP and CHAP Authentication</title>

	  <indexterm><primary>PAP</primary></indexterm>
	  <indexterm><primary>CHAP</primary></indexterm>
	  <para>Some ISPs set their system up so that the
	    authentication part of your connection is done using
	    either of the PAP or CHAP authentication mechanisms.  If
	    this is the case, your ISP will not give a
	    <prompt>login:</prompt> prompt when you connect, but will
	    start talking <acronym>PPP</acronym> immediately.</para>

	  <para>PAP is less secure than CHAP, but security is not
	    normally an issue here as passwords, although being sent
	    as plain text with PAP, are being transmitted down a
	    serial line only.  There is not much room for crackers
	    to <quote>eavesdrop</quote>.</para>

	  <para>Referring back to <xref
	      linkend="userppp-staticIP"/>
	    or <xref
	      linkend="userppp-dynamicIP"/>,
	    the following alterations must
	    be made:</para>

	  <programlisting>13      set authname <replaceable>MyUserName</replaceable>
14      set authkey <replaceable>MyPassword</replaceable>
15      set login</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term>Line 13:</term>

	      <listitem>
		<para>This line specifies your PAP/CHAP user name.
		  You will need to insert the correct value for
		  <replaceable>MyUserName</replaceable>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 14:</term>
	      <listitem>
		<para>This line specifies your PAP/CHAP
		  password<indexterm><primary>password</primary></indexterm>.
		  You will need to insert the correct value for
		  <replaceable>MyPassword</replaceable>.  You may
		  want to add an additional line, such as:</para>

		<programlisting>16      accept PAP</programlisting>

		<para>or</para>

		<programlisting>16      accept CHAP</programlisting>

		<para>to make it obvious that this is the intention,
		  but PAP and CHAP are both accepted by
		  default.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 15:</term>

	      <listitem>
		<para>Your ISP will not normally require that you log
		  into the server if you are using PAP or CHAP.  You
		  must therefore disable your <quote>set login</quote>
		  string.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</sect2>

	<sect2>
	  <title>Changing Your <command>ppp</command> Configuration
	    on the Fly</title>

	  <para>It is possible to talk to the <command>ppp</command>
	    program while it is running in the background, but only
	    if a suitable diagnostic port has been set up.  To do
	    this, add the following line to your configuration:</para>

	  <programlisting>set server /var/run/ppp-tun<replaceable>%d</replaceable> DiagnosticPassword 0177</programlisting>

	  <para>This will tell PPP to listen to the specified
	    &unix; domain socket, asking clients for the specified
	    password before allowing access.  The
	    <literal>%d</literal> in the name is replaced with the
	    <devicename>tun</devicename> device number that is in
	    use.</para>

	  <para>Once a socket has been set up, the &man.pppctl.8;
	    program may be used in scripts that wish to manipulate
	    the running program.</para>
	</sect2>

      <sect2 id="userppp-nat">
	<title>Using <acronym>PPP</acronym> Network Address
	  Translation Capability</title>

	<indexterm>
	  <primary><acronym>PPP</acronym></primary><secondary>NAT</secondary>
	</indexterm>

	<para>PPP has ability to use internal NAT without kernel
	  diverting capabilities.  This functionality may be enabled
	  by the following line in
	  <filename>/etc/ppp/ppp.conf</filename>:</para>

	<programlisting>nat enable yes</programlisting>

	<para>Alternatively, NAT may be enabled by command-line
	  option <literal>-nat</literal>. There is also
	  <filename>/etc/rc.conf</filename> knob named
	  <literal>ppp_nat</literal>, which is enabled by
	  default.</para>

	<para>If you use this feature, you may also find useful
	  the following <filename>/etc/ppp/ppp.conf</filename> options
	  to enable incoming connections forwarding:</para>

	<programlisting>nat port tcp 10.0.0.2:ftp ftp
nat port tcp 10.0.0.2:http http</programlisting>

	<para>or do not trust the outside at all</para>

	<programlisting>nat deny_incoming yes</programlisting>
      </sect2>

      <sect2 id="userppp-final">
	<title>Final System Configuration</title>

	<indexterm>
	  <primary><acronym>PPP</acronym></primary><secondary>configuration</secondary>
	</indexterm>

	<para>You now have <command>ppp</command> configured, but
	  there are a few more things to do before it is ready to
	  work.  They all involve editing the
	  <filename>/etc/rc.conf</filename> file.</para>

	<para>Working from the top down in this file, make sure the
	  <literal>hostname=</literal> line is set, e.g.:</para>

	<programlisting>hostname="foo.example.com"</programlisting>

	<para>If your ISP has supplied you with a static IP address
	  and name, it is probably best that you use this name as your
	  host name.</para>

	<para>Look for the <literal>network_interfaces</literal>
	  variable.  If you want to configure your system to dial your
	  ISP on demand, make sure the <devicename>tun0</devicename>
	  device is added to the list, otherwise remove it.</para>

	<programlisting>network_interfaces="lo0 tun0"
ifconfig_tun0=</programlisting>

	<note>
	  <para>The <literal>ifconfig_tun0</literal> variable should
	    be empty, and a file called
	    <filename>/etc/start_if.tun0</filename> should be created.
	    This file should contain the line:</para>

	  <programlisting>ppp -auto mysystem</programlisting>

	  <para>This script is executed at network configuration time,
	    starting your ppp daemon in automatic mode.  If you have
	    a LAN for which this machine is a gateway, you may also
	    wish to use the <option>-alias</option> switch.  Refer
	    to the manual page for further details.</para>
	</note>

	<para>Make sure that the router program is set to
	  <literal>NO</literal> with the following line in your
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting>router_enable="NO"</programlisting>

	<indexterm>
	  <primary><application>routed</application></primary>
	</indexterm>

	<para>It is important that the <command>routed</command>
	  daemon is not started, as <command>routed</command> tends
	  to delete the default routing table entries created by
	  <command>ppp</command>.</para>

	<para>It is probably a good idea to ensure that the
	  <literal>sendmail_flags</literal> line does not include the
	  <option>-q</option> option, otherwise
	  <command>sendmail</command> will attempt to do a network
	  lookup every now and then, possibly causing your machine
	  to dial out.  You may try:</para>

	<programlisting>sendmail_flags="-bd"</programlisting>

	<indexterm>
	  <primary><application>sendmail</application></primary>
	</indexterm>
	<para>The downside of this is that you must force
	  <command>sendmail</command> to re-examine the mail queue
	  whenever the ppp link is up by typing:</para>

	<screen>&prompt.root; <userinput>/usr/sbin/sendmail -q</userinput></screen>

	<para>You may wish to use the <command>!bg</command> command
	  in <filename>ppp.linkup</filename> to do this
	  automatically:</para>

	<programlisting>1     provider:
2       delete ALL
3       add 0 0 HISADDR
4       !bg sendmail -bd -q30m</programlisting>

	<indexterm>
	  <primary>SMTP</primary>
	</indexterm>

	<para>If you do not like this, it is possible to set up a
	  <quote>dfilter</quote> to block SMTP traffic.  Refer to the
	  sample files for further details.</para>

	<para>All that is left is to reboot the machine.  After
	  rebooting, you can now either type:</para>

	<screen>&prompt.root; <userinput>ppp</userinput></screen>

	<para>and then <command>dial provider</command> to start the
	  <acronym>PPP</acronym> session, or, if you want
	  <command>ppp</command> to establish sessions automatically
	  when there is outbound traffic (and you have not created the
	  <filename>start_if.tun0</filename> script), type:</para>

	<screen>&prompt.root; <userinput>ppp -auto provider</userinput></screen>
      </sect2>

      <sect2>
	<title>Summary</title>

	<para>To recap, the following steps are necessary when setting
	  up ppp for the first time:</para>

	<para>Client side:</para>

	<procedure>
	  <step>
	    <para>Ensure that the <devicename>tun</devicename> device
	      is built into your kernel.</para>
	  </step>

	  <step>
	    <para>Ensure that the <filename
		class="devicefile">tun<replaceable>N</replaceable></filename>
	      device file is available in the <filename
		class="directory">/dev</filename> directory.</para>
	  </step>

	  <step>
	    <para>Create an entry in
	      <filename>/etc/ppp/ppp.conf</filename>.  The
	      <filename>pmdemand</filename> example should suffice
	      for most ISPs.</para>
	  </step>

	  <step>
	    <para>If you have a dynamic IP address, create an entry in
	      <filename>/etc/ppp/ppp.linkup</filename>.</para>
	  </step>

	  <step>
	    <para>Update your <filename>/etc/rc.conf</filename>
	      file.</para>
	  </step>

	  <step>
	    <para>Create a <filename>start_if.tun0</filename> script
	      if you require demand dialing.</para>
	  </step>
	</procedure>

	<para>Server side:</para>

	<procedure>
	  <step>
	    <para>Ensure that the <devicename>tun</devicename> device
	      is built into your kernel.</para>
	  </step>

	  <step>
	    <para>Ensure that the
	      <filename
		class="devicefile">tun<replaceable>N</replaceable></filename>
	      device file is available in the <filename
		class="directory">/dev</filename> directory.</para>
	  </step>

	  <step>
	    <para>Create an entry in <filename>/etc/passwd</filename>
	      (using the &man.vipw.8; program).</para>
	  </step>

	  <step>
	    <para>Create a profile in this users home directory that
	      runs <command>ppp -direct direct-server</command> or
	      similar.</para>
	  </step>

	  <step>
	    <para>Create an entry in
	      <filename>/etc/ppp/ppp.conf</filename>.  The
	      <filename>direct-server</filename> example should
	      suffice.</para>
	  </step>

	  <step>
	    <para>Create an entry in
	      <filename>/etc/ppp/ppp.linkup</filename>.</para>
	  </step>

	  <step>
	    <para>Update your <filename>/etc/rc.conf</filename>
	      file.</para>
	  </step>
	</procedure>
    </sect2>
  </sect1>

  <sect1 id="ppp-troubleshoot">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Contributed by in June 2003</contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>Troubleshooting <acronym>PPP</acronym> Connections</title>

    <indexterm>
      <primary><acronym>PPP</acronym></primary>
      <secondary>troubleshooting</secondary>
    </indexterm>

    <para>This section covers a few issues which may arise when
      using <acronym>PPP</acronym> over a modem connection.  For
      instance, perhaps you need to know exactly what prompts the
      system you are dialing into will present.  Some
      <acronym>ISP</acronym>s present the
      <literal>ssword</literal> prompt, and others will present
      <literal>password</literal>; if the <command>ppp</command>
      script is not written accordingly, the login attempt will
      fail.  The most common way to debug <command>ppp</command>
      connections is by connecting manually.  The following
      information will walk you through a manual connection step by
      step.</para>

    <sect2>
      <title>Check the Device Nodes</title>

      <para>When using a custom kernel, make sure to include the
	following line in your kernel configuration file:</para>

      <programlisting>device   uart</programlisting>

      <para>The <devicename>uart</devicename> device is already
	included in the <literal>GENERIC</literal> kernel, so no
	additional steps are necessary in this case.  Just
	check the <command>dmesg</command> output for the modem
	device with:</para>

      <screen>&prompt.root; <userinput>dmesg | grep uart</userinput></screen>

      <para>You should get some pertinent output about the
	<devicename>uart</devicename> devices.  These are the COM
	ports we need.  If your modem acts like a standard serial
	port then you should see it listed on
	<devicename>uart1</devicename>, or
	<devicename>COM2</devicename>.  If so, you are not required
	to rebuild the kernel.  When matching up sio modem is on
	<devicename>uart1</devicename> or
	<devicename>COM2</devicename> if you are in DOS, then your
	modem device would be <filename
	  class="devicefile">/dev/cuau1</filename>.</para>
    </sect2>

    <sect2>
      <title>Connecting Manually</title>

      <para>Connecting to the Internet by manually controlling
	<command>ppp</command> is quick, easy, and a great way to
	debug a connection or just get information on how your
	<acronym>ISP</acronym> treats <command>ppp</command> client
	connections.  Lets start <application>PPP</application> from
	the command line.  Note that in all of our examples we will
	use <emphasis>example</emphasis> as the hostname of the
	machine running <application>PPP</application>.  You start
	<command>ppp</command> by just typing
	<command>ppp</command>:</para>

      <screen>&prompt.root; <userinput>ppp</userinput></screen>

      <para>We have now started <command>ppp</command>.</para>

      <screen>ppp ON example&gt; <userinput>set device <filename class="devicefile">/dev/cuau1</filename></userinput></screen>

      <para>We set our modem device, in this case it is
	<devicename>cuau1</devicename>.</para>

      <screen>ppp ON example&gt; <userinput>set speed 115200</userinput></screen>

      <para>Set the connection speed, in this case we
	are using 115,200 <acronym>kbps</acronym>.</para>

      <screen>ppp ON example&gt; <userinput>enable dns</userinput></screen>

      <para>Tell <command>ppp</command> to configure our
	resolver and add the nameserver lines to
	<filename>/etc/resolv.conf</filename>.  If
	<command>ppp</command> cannot determine our hostname, we can
	set one manually later.</para>

      <screen>ppp ON example&gt; <userinput>term</userinput></screen>

      <para>Switch to <quote>terminal</quote> mode so that we can
	manually control the modem.</para>

      <programlisting>deflink: Entering terminal mode on <filename class="devicefile">/dev/cuau1</filename>
type '~h' for help</programlisting>

      <screen><userinput>at</userinput>
OK
<userinput>atdt<replaceable>123456789</replaceable></userinput></screen>

      <para>Use <command>at</command> to initialize the modem,
	then use <command>atdt</command> and the number for your
	<acronym>ISP</acronym> to begin the dial in process.</para>

      <screen>CONNECT</screen>

      <para>Confirmation of the connection, if we are going to have
	any connection problems, unrelated to hardware, here is where
	we will attempt to resolve them.</para>

      <screen>ISP Login:<userinput>myusername</userinput></screen>

      <para>Here you are prompted for a username, return the
	prompt with the username that was provided by the
	<acronym>ISP</acronym>.</para>

      <screen>ISP Pass:<userinput>mypassword</userinput></screen>

      <para>This time we are prompted for a password, just
	reply with the password that was provided by the
	<acronym>ISP</acronym>.  Just like logging into
	&os;, the password will not echo.</para>

      <screen>Shell or PPP:<userinput>ppp</userinput></screen>

      <para>Depending on your <acronym>ISP</acronym> this prompt
	may never appear.  Here we are being asked if we wish to
	use a shell on the provider, or to start
	<command>ppp</command>.  In this example, we have chosen
	to use <command>ppp</command> as we want an Internet
	connection.</para>

      <screen>Ppp ON example&gt;</screen>

      <para>Notice that in this example the first <option>p</option>
	has been capitalized.  This shows that we have successfully
	connected to the <acronym>ISP</acronym>.</para>

      <screen>PPp ON example&gt;</screen>

      <para>We have successfully authenticated with our
	<acronym>ISP</acronym> and are waiting for the
	assigned <acronym>IP</acronym> address.</para>

      <screen>PPP ON example&gt;</screen>

      <para>We have made an agreement on an <acronym>IP</acronym>
	address and successfully completed our connection.</para>

      <screen>PPP ON example&gt;<userinput>add default HISADDR</userinput></screen>

      <para>Here we add our default route, we need to do this before
	we can talk to the outside world as currently the only
	established connection is with the peer.  If this fails due to
	existing routes you can put a bang character
	<literal>!</literal> in front of the <option>add</option>.
	Alternatively, you can set this before making the actual
	connection and it will negotiate a new route
	accordingly.</para>

      <para>If everything went good we should now have an active
	connection to the Internet, which could be thrown into the
	background using <keycombo
	action="simul"><keycap>CTRL</keycap>
	<keycap>z</keycap></keycombo> If you notice the
	<command>PPP</command> return to <command>ppp</command> then
	we have lost our connection.  This is good to know because it
	shows our connection status.  Capital P's show that we have a
	connection to the <acronym>ISP</acronym> and lowercase p's
	show that the connection has been lost for whatever reason.
	<command>ppp</command> only has these 2 states.</para>
      </sect2>

      <sect2>
	<title>Debugging</title>

	<para>If you have a direct line and cannot seem to make a
	  connection, then turn hardware flow
	  <acronym>CTS/RTS</acronym> to off with the <option>set
	  ctsrts off</option>.  This is mainly the case if you are
	  connected to some <application>PPP</application> capable
	  terminal servers, where <application>PPP</application> hangs
	  when it tries to write data to your communication link, so
	  it would be waiting for a <acronym>CTS</acronym>, or Clear
	  To Send signal which may never come.  If you use this option
	  however, you should also use the <option>set accmap</option>
	  option, which may be required to defeat hardware dependent
	  on passing certain characters from end to end, most of the
	  time XON/XOFF.  See the &man.ppp.8; manual page for more
	  information on this option, and how it is used.</para>

	<para>If you have an older modem, you may need to use the
	  <option>set parity even</option>.  Parity is set at none
	  be default, but is used for error checking (with a large
	  increase in traffic) on older modems and some
	  <acronym>ISP</acronym>s.  You may need this option for
	  the Compuserve <acronym>ISP</acronym>.</para>

	<para><application>PPP</application> may not return to the
	  command mode, which is usually a negotiation error where
	  the <acronym>ISP</acronym> is waiting for your side to start
	  negotiating.  At this point, using the <command>~p</command>
	  command will force ppp to start sending the configuration
	  information.</para>

	<para>If you never obtain a login prompt, then most likely you
	  need to use <acronym>PAP</acronym> or
	  <acronym>CHAP</acronym> authentication instead of the
	  &unix; style in the example above.  To use
	  <acronym>PAP</acronym> or <acronym>CHAP</acronym> just add
	  the following options to <application>PPP</application>
	  before going into terminal mode:</para>

	<screen>ppp ON example&gt; <userinput>set authname <replaceable>myusername</replaceable></userinput></screen>

	<para>Where <replaceable>myusername</replaceable> should be
	  replaced with the username that was assigned by the
	  <acronym>ISP</acronym>.</para>

	<screen>ppp ON example&gt; <userinput>set authkey <replaceable>mypassword</replaceable></userinput></screen>

	<para>Where <replaceable>mypassword</replaceable> should be
	  replaced with the password that was assigned by the
	  <acronym>ISP</acronym>.</para>

	<para>If you connect fine, but cannot seem to find any domain
	  name, try to use &man.ping.8; with an <acronym>IP</acronym>
	  address and see if you can get any return information.  If
	  you experience 100 percent (100%) packet loss, then it is
	  most likely that you were not assigned a default route.
	  Double check that the option <option>add default
	    HISADDR</option> was set during the connection.  If you
	  can connect to a remote <acronym>IP</acronym> address then
	  it is possible that a resolver address has not been added
	  to the <filename>/etc/resolv.conf</filename>.  This file
	  should look like:</para>

	<programlisting>domain <replaceable>example.com</replaceable>
nameserver <replaceable>x.x.x.x</replaceable>
nameserver <replaceable>y.y.y.y</replaceable></programlisting>

	<para>Where <replaceable>x.x.x.x</replaceable> and
	  <replaceable>y.y.y.y</replaceable> should be replaced with
	  the <acronym>IP</acronym> address of your
	  <acronym>ISP</acronym>'s DNS servers.  This information may
	  or may not have been provided when you signed up, but a
	  quick call to your <acronym>ISP</acronym> should remedy
	  that.</para>

	<para>You could also have &man.syslog.3; provide a logging
	  function for your <application>PPP</application> connection.
	  Just add:</para>

	<programlisting>!ppp
*.*     /var/log/ppp.log</programlisting>

      <para>to <filename>/etc/syslog.conf</filename>.  In most
	cases, this functionality already exists.</para>
    </sect2>
  </sect1>

  <sect1 id="pppoe">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Jim</firstname>
	  <surname>Mock</surname>
	  <contrib>Contributed (from
	    http://node.to/freebsd/how-tos/how-to-freebsd-pppoe.html)
	    by in Jan 2000</contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>Using <acronym>PPP</acronym> over Ethernet (PPPoE)</title>

    <indexterm>
      <primary><acronym>PPP</acronym></primary>
      <secondary>over Ethernet</secondary>
    </indexterm>

    <para>This section describes how to set up
      <acronym>PPP</acronym> over Ethernet
      (<acronym>PPPoE</acronym>).</para>

      <para>Here is an example of a working
	<filename>ppp.conf</filename>:</para>

      <programlisting>default:
  set log Phase tun command # you can add more detailed logging if you wish
  set ifaddr 10.0.0.1/0 10.0.0.2/0

name_of_service_provider:
  set device PPPoE:<replaceable>xl1</replaceable> # replace xl1 with your Ethernet device
  set authname YOURLOGINNAME
  set authkey YOURPASSWORD
  set dial
  set login
  add default HISADDR</programlisting>

      <para>As <username>root</username>, you can run:</para>

      <screen>&prompt.root; <userinput>ppp -ddial name_of_service_provider</userinput></screen>

      <title>Starting <application>ppp</application> at Boot</title>

      <para>Add the following to your
	<filename>/etc/rc.conf</filename> file:</para>

      <programlisting>ppp_enable="YES"
ppp_mode="ddial"
ppp_nat="YES"	# if you want to enable nat for your local network, otherwise NO
ppp_profile="name_of_service_provider"</programlisting>

    <sect2>
      <title>Using a PPPoE Service Tag</title>

      <para>Sometimes it will be necessary to use a service tag to
	establish your connection.  Service tags are used to
	distinguish between different PPPoE servers attached to a
	given network.</para>

      <para>You should have been given any required service tag
	information in the documentation provided by your ISP.  If
	you cannot locate it there, ask your ISP's tech support
	personnel.</para>

      <para>As a last resort, you could try installing the <filename
	  role="package">net/rr-pppoe</filename> package or port.
	Bear in mind however, this may de-program your modem and
	render it useless, so think twice before doing it.  Simply
	install the program shipped with the modem by your provider.
	Then, access the <guimenu>System</guimenu> menu from the
	program.  The name of your profile should be listed there.  It
	is usually <emphasis>ISP</emphasis>.</para>

      <para>The profile name (service tag) will be used in the PPPoE
	configuration entry in <filename>ppp.conf</filename> as the
	provider part of the <command>set device</command> command
	(see the &man.ppp.8; manual page for full details).  It should
	look like this:</para>

      <programlisting>set device PPPoE:<replaceable>xl1</replaceable>:<replaceable>ISP</replaceable></programlisting>

      <para>Do not forget to change <replaceable>xl1</replaceable>
	to the proper device for your Ethernet card.</para>

      <para>Do not forget to change <replaceable>ISP</replaceable>
	to the profile you have just found above.</para>

      <para>For additional information, refer to <ulink
	  url="http://renaud.waldura.com/doc/freebsd/pppoe/">Cheaper
	  Broadband with &os; on DSL</ulink> by Renaud
	Waldura.</para>
    </sect2>

    <sect2 id="ppp-3com">

      <title>PPPoE with a &tm.3com;
	<trademark class="registered">HomeConnect</trademark> ADSL
	Modem Dual Link</title>

      <para>This modem does not follow <ulink
	  url="http://www.faqs.org/rfcs/rfc2516.html">RFC 2516</ulink>
	(<emphasis>A Method for transmitting <acronym>PPP</acronym>
	over Ethernet (PPPoE)</emphasis>, written by L. Mamakos, K.
	Lidl, J. Evarts, D. Carrel, D. Simone, and R. Wheeler).
	Instead, different packet type codes have been used for the
	Ethernet frames.  Please complain to <ulink
	  url="http://www.3com.com/">3Com</ulink> if you think it
	should comply with the PPPoE specification.</para>

      <para>In order to make &os; capable of communicating with
	this device, a sysctl must be set.  This can be done
	automatically at boot time by updating
	<filename>/etc/sysctl.conf</filename>:</para>

	<programlisting>net.graph.nonstandard_pppoe=1</programlisting>

      <para>or can be done immediately with the command:</para>

      <screen>&prompt.root; <userinput>sysctl net.graph.nonstandard_pppoe=1</userinput></screen>

      <para>Unfortunately, because this is a system-wide setting,
	it is not possible to talk to a normal PPPoE client or server
	and a &tm.3com; <trademark
	  class="registered">HomeConnect</trademark> ADSL Modem at
	the same time.</para>
    </sect2>
  </sect1>

  <sect1 id="pppoa">
    <title>Using <application>PPP</application> over ATM
      (PPPoA)</title>

    <indexterm>
      <primary><acronym>PPP</acronym></primary>
      <secondary>over ATM</secondary>
    </indexterm>

    <indexterm>
      <primary>PPPoA</primary>
    </indexterm>

    <para>The following describes how to set up PPP over ATM (PPPoA).
      PPPoA is a popular choice among European DSL providers.</para>
<!--
This port is broken as of June, 2009
    <sect2>
      <title>Using PPPoA with the Alcatel &speedtouch; USB</title>

      <para>PPPoA support for this device is supplied as a port in
	&os; because the firmware is distributed under <ulink
	url="http://www.speedtouchdsl.com/disclaimer_lx.htm">Alcatel's
	license agreement</ulink> and can not be redistributed freely
	with the base system of &os;.</para>

      <para>This software can be installed using the
	<filename role="package">net/pppoa</filename> package or port.  Once installed, follow
	the instructions provided with it.</para>

      <para>Like many USB devices, the Alcatel &speedtouch; USB needs
	to download firmware from the host computer to operate
	properly.  It is possible to automate this process in &os;
	so that this transfer takes place whenever the device is
	plugged into a USB port.  The following information can be
	added to the <filename>/etc/usbd.conf</filename> file to
	enable this automatic firmware transfer.  This file must be
	edited as the <username>root</username> user.</para>

      <programlisting>device "Alcatel SpeedTouch USB"
    devname "ugen[0-9]+"
    vendor 0x06b9
    product 0x4061
    attach "/usr/local/sbin/modem_run -f /usr/local/libdata/mgmt.o"</programlisting>

      <para>To enable the USB daemon, <application>usbd</application>,
	put the following the line into
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting>usbd_enable="YES"</programlisting>

      <para>It is also possible to set up
	<application>ppp</application> to dial up at startup.  To do
	this add the following lines to
	<filename>/etc/rc.conf</filename>.  Again, for this procedure
	you will need to be logged in as the <username>root</username>
	user.</para>

      <programlisting>ppp_enable="YES"
ppp_mode="ddial"
ppp_profile="adsl"</programlisting>

      <para>For this to work correctly you will need to have used the
	sample <filename>ppp.conf</filename> which is supplied with
	the <filename role="package">net/pppoa</filename> port.</para>
    </sect2>
    -->

    <sect2>
      <title>Using mpd</title>

      <para>You can use <application>mpd</application> to connect to a
	variety of services, in particular PPTP services.  You can
	find <application>mpd</application> in the Ports Collection,
	<filename role="package">net/mpd5</filename>.  Many ADSL
	modems require that a PPTP tunnel is created between the modem
	and computer, one such modem is the Alcatel &speedtouch;
	Home.</para>

      <para>First you must install the port, and then you can
	configure <application>mpd</application> to suit your
	requirements and provider settings.  The port places a set
	of sample configuration files which are well documented in
	<filename
	  class="directory"><replaceable>PREFIX</replaceable>/etc/mpd/</filename>.
	Note here that <replaceable>PREFIX</replaceable> means the
	directory into which your ports are installed, this defaults
	to <filename class="directory">/usr/local/</filename>. A
	complete guide to configure <application>mpd</application>
	is available in HTML format once the port has been installed.
	It is placed in <filename
	  class="directory"><replaceable>PREFIX</replaceable>/share/doc/mpd/</filename>.
	Here is a sample configuration for connecting to an ADSL
	service with <application>mpd</application>. The configuration
	is spread over two files, first the
	<filename>mpd.conf</filename>:</para>

      <note>
	<para>This example of the <filename>mpd.conf</filename> file
	  only works with <application>mpd</application> 4.x.</para>
      </note>

      <programlisting>default:
    load adsl

adsl:
    new -i ng0 adsl adsl
    set bundle authname <replaceable>username</replaceable> <co
    id="co-mpd-ex-user"/>
    set bundle password <replaceable>password</replaceable> <co
    id="co-mpd-ex-pass"/>
    set bundle disable multilink

    set link no pap acfcomp protocomp
    set link disable chap
    set link accept chap
    set link keep-alive 30 10

    set ipcp no vjcomp
    set ipcp ranges 0.0.0.0/0 0.0.0.0/0

    set iface route default
    set iface disable on-demand
    set iface enable proxy-arp
    set iface idle 0

    open</programlisting>

    <calloutlist>
      <callout arearefs="co-mpd-ex-user">
	<para>The username used to authenticate with your ISP.</para>
      </callout>
      <callout arearefs="co-mpd-ex-pass">
	<para>The password used to authenticate with your ISP.</para>
      </callout>
    </calloutlist>

    <para>The <filename>mpd.links</filename> file contains information
      about the link, or links, you wish to establish.  An example
      <filename>mpd.links</filename> to accompany the above example
      is given beneath:</para>

    <programlisting>adsl:
    set link type pptp
    set pptp mode active
    set pptp enable originate outcall
    set pptp self <replaceable>10.0.0.1</replaceable> <co
    id="co-mpd-ex-self"/>
    set pptp peer <replaceable>10.0.0.138</replaceable> <co
    id="co-mpd-ex-peer"/></programlisting>

    <calloutlist>
      <callout arearefs="co-mpd-ex-self">
	<para>The IP address of your &os; computer which you will be
	  using <application>mpd</application> from.</para>
      </callout>
      <callout arearefs="co-mpd-ex-peer">
	<para>The IP address of your ADSL modem.  For the Alcatel
	  &speedtouch; Home this address defaults to <hostid
	    role="ipaddr">10.0.0.138</hostid>.</para>
      </callout>
    </calloutlist>

    <para>It is possible to initialize the connection easily by
      issuing the following command as
      <username>root</username>:</para>

    <screen>&prompt.root; <userinput>mpd -b <replaceable>adsl</replaceable></userinput></screen>

    <para>You can see the status of the connection with the following
      command:</para>

    <screen>&prompt.user; <userinput>ifconfig <replaceable>ng0</replaceable></userinput>
ng0: flags=88d1&lt;UP,POINTOPOINT,RUNNING,NOARP,SIMPLEX,MULTICAST&gt; mtu 1500
     inet 216.136.204.117 --> 204.152.186.171 netmask 0xffffffff</screen>

    <para>Using <application>mpd</application> is the recommended
      way to connect to an ADSL service with &os;.</para>
  </sect2>

  <sect2>
    <title>Using pptpclient</title>

    <para>It is also possible to use &os; to connect to other
      PPPoA services using <filename
	role="package">net/pptpclient</filename>.</para>

    <para>To use <filename role="package">net/pptpclient</filename>
      to connect to a DSL service, install the port or package and
      edit your <filename>/etc/ppp/ppp.conf</filename>. You will
      need to be <username>root</username> to perform both of these
      operations.  An example section of <filename>ppp.conf</filename>
      is given below.  For further information on
      <filename>ppp.conf</filename> options consult the
      <application>ppp</application> manual page, &man.ppp.8;.</para>

    <programlisting>adsl:
 set log phase chat lcp ipcp ccp tun command
 set timeout 0
 enable dns
 set authname <replaceable>username</replaceable> <co id="co-pptp-ex-user"/>
 set authkey <replaceable>password</replaceable> <co id="co-pptp-ex-pass"/>
 set ifaddr 0 0
 add default HISADDR</programlisting>

    <calloutlist>
      <callout arearefs="co-pptp-ex-user">
	<para>The username of your account with the DSL
	  provider.</para>
      </callout>

      <callout arearefs="co-pptp-ex-pass">
	<para>The password for your account.</para>
      </callout>
    </calloutlist>

    <warning>
      <para>Because you must put your account's password in the
	<filename>ppp.conf</filename> file in plain text form you
	should make sure than nobody can read the contents of this
	file.  The following series of commands will make sure the
	file is only readable by the <username>root</username>
	account.  Refer to the manual pages for &man.chmod.1; and
	&man.chown.8; for further information.</para>

      <screen>&prompt.root; <userinput>chown root:wheel /etc/ppp/ppp.conf</userinput>
&prompt.root; <userinput>chmod 600 /etc/ppp/ppp.conf</userinput></screen>

      </warning>

      <para>This will open a tunnel for a <acronym>PPP</acronym>
	session to your DSL router.  Ethernet DSL modems have a
	preconfigured LAN IP address which you connect to.  In the
	case of the Alcatel &speedtouch; Home this address is <hostid
	  role="ipaddr">10.0.0.138</hostid>. Your router
	documentation should tell you which address your device
	uses.  To open the tunnel and start a <acronym>PPP</acronym>
	session execute the following command:</para>

      <screen>&prompt.root; <userinput>pptp <replaceable>address</replaceable> <replaceable>adsl</replaceable></userinput></screen>

      <tip>
	<para>You may wish to add an ampersand (<quote>&amp;</quote>)
	  to the end of the previous command because
	  <application>pptp</application> will not return your prompt
	  to you otherwise.</para>
      </tip>

      <para>A <devicename>tun</devicename> virtual tunnel device
	will be created for interaction between the
	<application>pptp</application> and
	<application>ppp</application> processes.  Once you have been
	returned to your prompt, or the
	<application>pptp</application> process has confirmed a
	connection you can examine the tunnel like so:</para>

      <screen>&prompt.user; <userinput>ifconfig <replaceable>tun0</replaceable></userinput>
tun0: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1500
        inet 216.136.204.21 --> 204.152.186.171 netmask 0xffffff00
	Opened by PID 918</screen>

      <para>If you are unable to connect, check the configuration of
	your router, which is usually accessible via
	<application>telnet</application> or with a web browser.  If
	you still cannot connect you should examine the output of the
	<command>pptp</command> command and the contents of the
	<application>ppp</application> log file,
	<filename>/var/log/ppp.log</filename> for clues.</para>
    </sect2>
  </sect1>
</chapter>
